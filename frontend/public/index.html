<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassReconnect Dashboard</title>
    <script>
        // Redirect to landing page if accessed directly via root URL
        if (window.location.href === 'http://localhost:3000/' || 
            window.location.href === 'http://localhost:3000' ||
            window.location.href === 'http://localhost:3000/index.html') {
            window.location.href = '/landing.html';
        }
    </script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for webkit browsers */
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 2px;
        }
        .quiz-option:hover {
            background-color: #f0f4ff;
        }
        .quiz-option input:checked + label {
            border-color: #3b82f6;
            background-color: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-slate-800 text-white flex flex-col fixed h-full sidebar-scroll overflow-y-auto z-30 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <!-- Logo -->
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 h-8 w-8 mr-2"><path d="M12 22h6a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h2"></path><path d="M10 18a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"></path><path d="M2 6h4"></path><path d="M2 10h4"></path><path d="M2 14h4"></path></svg>
                    <h1 class="text-xl font-bold">ClassReconnect</h1>
                </div>
                <button id="sidebar-close" class="lg:hidden p-1 text-slate-400 hover:text-white">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <!-- Navigation -->
            <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider">Navigation</p>
                <a href="#dashboard" class="flex items-center px-4 py-2 text-sm font-medium bg-slate-700 text-blue-300 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><rect width="7" height="9" x="3" y="3" rx="1"></rect><rect width="7" height="5" x="14" y="3" rx="1"></rect><rect width="7" height="9" x="14" y="12" rx="1"></rect><rect width="7" height="5" x="3" y="16" rx="1"></rect></svg>
                    Dashboard
                </a>
                <a href="#library" class="flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Library
                </a>
                <a href="qa.html" class="flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3">
                        <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2Z"></path>
                    </svg>
                    AI Assistant
                </a>
                <a href="#qa" id="qa-nav-link" class="hidden flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    Q&A
                </a>
                <a href="#courses" class="flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><path d="M12 2v20"></path><path d="M2 12h20"></path></svg>
                    Courses
                </a>
                <a href="#quizzes" id="quizzes-nav-link" class="hidden flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                    Quizzes
                </a>
                <a href="#student-quizzes" id="student-quizzes-nav-link" class="flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                    Quizzes
                </a>
                <a href="#contribute" id="contribute-nav-link" class="hidden flex items-center px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                    Contribute Notes
                </a>
            </nav>

            <!-- Profile Footer -->
            <div class="p-4 mt-auto border-t border-slate-700">
                <div class="flex items-center">
                    <a href="#profile" class="inline-block">
                        <img id="profile-avatar" class="h-10 w-10 rounded-full cursor-pointer" src="https://placehold.co/100x100/7c3aed/ffffff?text=SU" alt="User Avatar">
                    </a>
                    <div class="ml-3">
                        <p id="profile-name" class="text-sm font-medium text-white">Student User</p>
                        <p id="profile-details" class="text-xs text-slate-400">COMPS • Semester 5</p>
                    </div>
                    <button class="ml-auto text-slate-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>
                    </button>
                </div>
                
                <button id="logout-button" class="w-full text-center mt-2 bg-slate-700 text-sm text-slate-200 py-2 rounded-lg hover:bg-slate-600 transition-colors">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="lg:ml-64 flex-1 p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div id="main-header" class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <!-- This content will be replaced by JavaScript -->
                </div>

                <!-- Page Content -->
                <div id="dashboard-content">
                    <!-- Dashboard Grid -->
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <!-- Left/Center Column -->
                        <div class="xl:col-span-2 space-y-6">
                            <!-- Stats Cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                <div class="bg-white p-6 rounded-xl shadow-sm flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Resources Available</p>
                                        <p id="dashboard-resource-count" class="text-4xl font-bold text-slate-800 mt-1"></p>
                                        
                                    </div>
                                    <div class="bg-blue-100 text-blue-600 p-3 rounded-lg">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                                    </div>
                                </div>
                                <!-- Available Quizzes Card -->
                                <div class="bg-white p-6 rounded-xl shadow-sm flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Available Quizzes</p>
                                        <p id="dashboard-quiz-count" class="text-4xl font-bold text-slate-800 mt-1">0</p>
                                    </div>
                                    <div class="bg-green-100 text-green-600 p-3 rounded-lg">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><circle cx="12" cy="12" r="10"></circle><path d="M10 8h4"></path><path d="M8 12h8"></path><path d="M9 16h6"></path></svg>
                                    </div>
                                </div>
                                <div id="qa-stat-card" class="hidden bg-white p-6 rounded-xl shadow-sm flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Active Questions</p>
                                        <p class="text-4xl font-bold text-slate-800 mt-1">0</p>
                                    </div>
                                    <div class="bg-green-100 text-green-600 p-3 rounded-lg">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Resources Used -->
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-slate-800">Recent Resources Used</h3>
                                </div>
                                <div id="recent-resources-container" class="space-y-4">
                                     <p class="text-slate-500">No resources viewed recently. Go to the library to start exploring!</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-6">
                            <!-- Profile Card -->
                            <div class="bg-blue-600 text-white p-8 rounded-xl shadow-lg text-center flex flex-col items-center">
                                <div class="relative">
                                    <a href="#profile" class="inline-block">
                                        <img id="dashboard-profile-avatar" src="https://placehold.co/100x100/ffffff/3b82f6?text=KV" alt="Karan Vora" class="w-24 h-24 rounded-full border-4 border-white shadow-md cursor-pointer">
                                    </a>
                                </div>
                                <h3 id="dashboard-profile-name" class="text-xl font-bold mt-4">Karan Vora</h3>
                                <p id="dashboard-profile-details" class="text-sm text-blue-200">COMPS • Semester 5</p>
                                <div class="mt-4 text-sm bg-blue-700/50 px-3 py-1 rounded-full">
                                    <span class="font-bold text-yellow-300">★</span> 120 reputation
                                </div>
                            </div>
                            <!-- Quick Actions Card -->
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="text-lg font-bold text-slate-800">Quick Actions</h3>
                                <div class="mt-4 space-y-2">
                                    <a href="qa.html" class="block w-full text-left bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2Z"></path>
                                        </svg>
                                        <span>Ask AI Assistant</span>
                                    </a>
                                    <a href="#library" class="block w-full text-left bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg transition-colors">Browse Library</a>
                                    <a href="#qa" id="quick-action-qa" class="hidden block w-full text-left bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg transition-colors">View Your Questions</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="library-content" class="hidden">
                     <!-- Filters -->
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <div class="relative lg:col-span-2">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                </div>
                                <input type="text" placeholder="Search notes..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <select id="semester-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option>All Semesters</option>
                                <option>Semester 1</option>
                                <option>Semester 2</option>
                                <option>Semester 3</option>
                                <option>Semester 4</option>
                                <option>Semester 5</option>
                                <option>Semester 6</option>
                                <option>Semester 7</option>
                                <option>Semester 8</option>
                            </select>
                            <select id="subject-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option>All Subjects</option>
                                <option>Data Structures</option>
                                <option>DBMS</option>
                                <option>DLCOA</option>
                                <option>DSGT</option>
                                <option>MATHS</option>
                            </select>
                            <select id="type-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option>All Types</option>
                                <option>Notes</option>
                                <option>PYQ</option>
                                <option>Short Notes</option>
                                <option>Assignments</option>
                                <option>E-Books</option>
                            </select>
                            <select id="branch-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option>All Branches</option>
                                <option>COMPS</option>
                                <option>IT</option>
                                <option>AIDS</option>
                                <option>EXTC</option>
                            </select>
                        </div>
                    </div>

                    <p id="resource-count" class="text-sm text-slate-600 mb-4">Showing 26 of 26 resources</p>

                    <div id="library-actions" class="mb-4">
                        <button id="remove-all-resources" class="hidden bg-red-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-red-700 transition-colors">Remove All Resources</button>
                    </div>

                    <!-- Library Grid -->
                    <div id="library-grid" class="grid grid-cols-1 md-grid-cols-2 lg-grid-cols-3 gap-6">
                        <!-- Resource cards will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- No results message (initially hidden) -->
                    <div id="no-results" class="hidden text-center py-12 bg-white rounded-xl shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-slate-400"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <h3 class="mt-2 text-lg font-semibold text-slate-800">No Resources Found</h3>
                        <p class="mt-1 text-sm text-slate-500">
                            Try adjusting your filters to find what you're looking for.
                        </p>
                    </div>
                </div>

                <!-- Courses Page Content -->
                <div id="courses-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">Courses</h2>
                        <p class="text-slate-500 mb-6">Choose a course to view its syllabus and resources.</p>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
                                <div class="relative group">
                                    <img src="/assets/images/courses/c.jpeg" alt="C Programming" class="w-full h-36 object-cover rounded-md mb-4 transition-transform duration-300 group-hover:scale-105">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-md flex items-end">
                                        <span class="text-white text-sm font-medium p-3">Master C Programming</span>
                                    </div>
                                </div>
                                <h3 class="font-bold text-lg">C Language</h3>
                                <p class="text-sm text-slate-500 mt-2">Fundamentals of C programming: data types, control flow, functions, pointers.</p>
                                <div class="mt-4">
                                    <a href="https://www.youtube.com/watch?v=KnvbUiSxvbM&list=PLVlQHNRLflP8IGz6OXwlV_lgHgc72aXlh" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:underline">Watch Tutorial →</a>
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
                                <img src="assets/images/courses/c++.png" alt="C++" class="w-full h-36 object-cover rounded-md mb-4">
                                <h3 class="font-bold text-lg">C++</h3>
                                <p class="text-sm text-slate-500 mt-2">Object-oriented programming, STL, memory management, templates.</p>
                                <div class="mt-4">
                                    <a href="https://www.youtube.com/watch?v=j8nAHeVKL08&list=PLu0W_9lII9agpFUAlPFe_VNSlXW5uE0YL" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:underline">Watch Tutorial →</a>
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
                                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='240'><rect width='100%' height='100%' fill='%23f59e0b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='36' fill='white' font-family='Arial'>Java</text></svg>" alt="Java" class="w-full h-36 object-cover rounded-md mb-4">
                                <h3 class="font-bold text-lg">Java</h3>
                                <p class="text-sm text-slate-500 mt-2">Core Java, OOP, collections, multithreading and JVM internals.</p>
                                <div class="mt-4">
                                    <a href="https://www.youtube.com/watch?v=yRpLlJmRo2w&list=PLfqMhTWNBTe3LtFWcvwpqTkUSlB32kJop" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:underline">Watch Tutorial →</a>
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
                                <img src="assets/images/courses/python.jpg" alt="Python" class="w-full h-36 object-cover rounded-md mb-4">
                                <h3 class="font-bold text-lg">Python</h3>
                                <p class="text-sm text-slate-500 mt-2">Python essentials, scripting, data structures, and basic libraries.</p>
                                <div class="mt-4">
                                    <a href="https://www.youtube.com/watch?v=gfDE2a7MKjA&list=PLu0W_9lII9agICnT8t4iYVSZ3eykIAOME" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:underline">Watch Tutorial →</a>
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
                                <img src="assets/images/courses/mern-stack.jpg" alt="MERN" class="w-full h-36 object-cover rounded-md mb-4">
                                <h3 class="font-bold text-lg">MERN Stack Development</h3>
                                <p class="text-sm text-slate-500 mt-2">MongoDB, Express, React, Node.js — full-stack web development.</p>
                                <div class="mt-4">
                                    <a href="https://www.youtube.com/watch?v=7CqJlxBYj-M" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:underline">Watch Tutorial →</a>
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
                                <img src="assets/images/courses/web-dev.jpeg" alt="Web App" class="w-full h-36 object-cover rounded-md mb-4">
                                <h3 class="font-bold text-lg">Web App Development</h3>
                                <p class="text-sm text-slate-500 mt-2">Frontend & backend basics: HTML, CSS, JavaScript, deployment.</p>
                                <div class="mt-4">
                                    <a href="https://www.youtube.com/watch?v=6mbwJ2xhgzM&list=PLu0W_9lII9agiCUZYRsvtGTXdxkzPyItg" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:underline">Watch Tutorial →</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contribute Notes Page Content (Teachers Only) -->
                <div id="contribute-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Contribute Notes</h2>
                        <p class="text-slate-500 mb-6">Upload educational resources to share with students.</p>
                        
                        <form id="contribute-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="contribute-branch" class="block text-sm font-medium text-slate-700 mb-1">Branch *</label>
                                    <select id="contribute-branch" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Branch</option>
                                        <option value="COMPS">COMPS</option>
                                        <option value="IT">IT</option>
                                        <option value="AIDS">AIDS</option>
                                        <option value="EXTC">EXTC</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="contribute-semester" class="block text-sm font-medium text-slate-700 mb-1">Semester *</label>
                                    <select id="contribute-semester" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Semester</option>
                                        <option value="Semester 1">Semester 1</option>
                                        <option value="Semester 2">Semester 2</option>
                                        <option value="Semester 3">Semester 3</option>
                                        <option value="Semester 4">Semester 4</option>
                                        <option value="Semester 5">Semester 5</option>
                                        <option value="Semester 6">Semester 6</option>
                                        <option value="Semester 7">Semester 7</option>
                                        <option value="Semester 8">Semester 8</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="contribute-subject" class="block text-sm font-medium text-slate-700 mb-1">Subject *</label>
                                    <select id="contribute-subject" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Subject</option>
                                        <option value="Data Structures">Data Structures</option>
                                        <option value="DBMS">DBMS</option>
                                        <option value="DLCOA">DLCOA</option>
                                        <option value="DSGT">DSGT</option>
                                        <option value="MATHS">MATHS</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="contribute-type" class="block text-sm font-medium text-slate-700 mb-1">Notes Type *</label>
                                    <select id="contribute-type" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Type</option>
                                        <option value="Notes">Notes</option>
                                        <option value="PYQ">PYQ</option>
                                        <option value="Short Notes">Short Notes</option>
                                        <option value="Assignments">Assignments</option>
                                        <option value="E-Books">E-Books</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="contribute-title" class="block text-sm font-medium text-slate-700 mb-1">Name of File *</label>
                                <input type="text" id="contribute-title" required placeholder="e.g., Module 1: Introduction to Data Structures" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label for="contribute-description" class="block text-sm font-medium text-slate-700 mb-1">Description (Optional)</label>
                                <textarea id="contribute-description" rows="3" placeholder="Brief description of the resource..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div>
                                <label for="contribute-file" class="block text-sm font-medium text-slate-700 mb-1">Choose File *</label>
                                <input type="file" id="contribute-file" required accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <p class="mt-1 text-xs text-slate-500">Supported formats: PDF, DOC, DOCX, PPT, PPTX, TXT (No size limit)</p>
                            </div>
                            
                            <div class="pt-4">
                                <button type="submit" id="upload-resource-btn" class="w-full flex items-center justify-center bg-green-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                    Upload Resource
                                </button>
                            </div>
                        </form>
                        
                        <div id="upload-status" class="hidden mt-4 p-4 rounded-lg"></div>
                    </div>
                </div>

                <!-- Quizzes Page Content -->
                <div id="quizzes-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Quiz Management</h2>
                        <p class="text-slate-500 mb-6">Manage your quizzes.</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Create Quiz Box -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">Create Quiz</h3>
                                <form id="create-quiz-form" class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="quiz-name" class="block text-sm font-medium text-slate-700 mb-1">Quiz Name *</label>
                                            <input type="text" id="quiz-name" required placeholder="e.g., Data Structures Quiz 1" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="quiz-duration" class="block text-sm font-medium text-slate-700 mb-1">Duration (minutes) *</label>
                                            <input type="number" id="quiz-duration" required min="1" max="180" value="60" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label for="quiz-branch" class="block text-sm font-medium text-slate-700 mb-1">Branch *</label>
                                            <select id="quiz-branch" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">Select Branch</option>
                                                <option value="COMPS">COMPS</option>
                                                <option value="IT">IT</option>
                                                <option value="AIDS">AIDS</option>
                                                <option value="EXTC">EXTC</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="quiz-semester" class="block text-sm font-medium text-slate-700 mb-1">Semester *</label>
                                            <select id="quiz-semester" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">Select Semester</option>
                                                <option value="Semester 1">Semester 1</option>
                                                <option value="Semester 2">Semester 2</option>
                                                <option value="Semester 3">Semester 3</option>
                                                <option value="Semester 4">Semester 4</option>
                                                <option value="Semester 5">Semester 5</option>
                                                <option value="Semester 6">Semester 6</option>
                                                <option value="Semester 7">Semester 7</option>
                                                <option value="Semester 8">Semester 8</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="quiz-subject" class="block text-sm font-medium text-slate-700 mb-1">Subject *</label>
                                            <select id="quiz-subject" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">Select Subject</option>
                                                <option value="Data Structures">Data Structures</option>
                                                <option value="DBMS">DBMS</option>
                                                <option value="DLCOA">DLCOA</option>
                                                <option value="DSGT">DSGT</option>
                                                <option value="MATHS">MATHS</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="quiz-set-paper" class="block text-sm font-medium text-slate-700 mb-1">Set Paper *</label>
                                            <select id="quiz-set-paper" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">Select Set Paper</option>
                                                <option value="Set A">Set A</option>
                                                <option value="Set B">Set B</option>
                                                <option value="Set C">Set C</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="quiz-num-questions" class="block text-sm font-medium text-slate-700 mb-1">Number of Questions *</label>
                                        <select id="quiz-num-questions" required class="w-full md:w-1/3 px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="5">5 Questions</option>
                                            <option value="10">10 Questions</option>
                                            <option value="15">15 Questions</option>
                                            <option value="20">20 Questions</option>
                                        </select>
                                    </div>
                                    
                                    <div class="pt-4">
                                        <button type="submit" id="create-quiz-btn" class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                                            Create Quiz
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- View Quiz Box -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">View Quiz</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="view-quiz-branch" class="block text-sm font-medium text-slate-700 mb-1">Branch</label>
                                        <select id="view-quiz-branch" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Branches</option>
                                            <option value="COMPS">COMPS</option>
                                            <option value="IT">IT</option>
                                            <option value="AIDS">AIDS</option>
                                            <option value="EXTC">EXTC</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="view-quiz-semester" class="block text-sm font-medium text-slate-700 mb-1">Semester</label>
                                        <select id="view-quiz-semester" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Semesters</option>
                                            <option value="Semester 1">Semester 1</option>
                                            <option value="Semester 2">Semester 2</option>
                                            <option value="Semester 3">Semester 3</option>
                                            <option value="Semester 4">Semester 4</option>
                                            <option value="Semester 5">Semester 5</option>
                                            <option value="Semester 6">Semester 6</option>
                                            <option value="Semester 7">Semester 7</option>
                                            <option value="Semester 8">Semester 8</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="view-quiz-subject" class="block text-sm font-medium text-slate-700 mb-1">Subject</label>
                                        <select id="view-quiz-subject" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Subjects</option>
                                            <option value="Data Structures">Data Structures</option>
                                            <option value="DBMS">DBMS</option>
                                            <option value="DLCOA">DLCOA</option>
                                            <option value="DSGT">DSGT</option>
                                            <option value="MATHS">MATHS</option>
                                        </select>
                                    </div>
                                    <div class="pt-4">
                                        <button id="view-quiz-btn" class="w-full flex items-center justify-center bg-green-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                            View Quizzes
                                        </button>
                                    </div>
                                    <div id="view-quiz-results" class="mt-4 space-y-3">
                                        <!-- Quiz results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Quizzes Page Content -->
                <div id="student-quizzes-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Available Quizzes</h2>
                        <p class="text-slate-500 mb-6">Take quizzes to test your knowledge.</p>
                        
                        <!-- Filter section for student quizzes -->
                        <div class="bg-slate-50 p-4 rounded-lg mb-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">Filter Quizzes</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="student-quiz-branch" class="block text-sm font-medium text-slate-700 mb-1">Branch</label>
                                    <select id="student-quiz-branch" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">All Branches</option>
                                        <option value="COMPS">COMPS</option>
                                        <option value="IT">IT</option>
                                        <option value="AIDS">AIDS</option>
                                        <option value="EXTC">EXTC</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="student-quiz-semester" class="block text-sm font-medium text-slate-700 mb-1">Semester</label>
                                    <select id="student-quiz-semester" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">All Semesters</option>
                                        <option value="Semester 1">Semester 1</option>
                                        <option value="Semester 2">Semester 2</option>
                                        <option value="Semester 3">Semester 3</option>
                                        <option value="Semester 4">Semester 4</option>
                                        <option value="Semester 5">Semester 5</option>
                                        <option value="Semester 6">Semester 6</option>
                                        <option value="Semester 7">Semester 7</option>
                                        <option value="Semester 8">Semester 8</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="student-quiz-subject" class="block text-sm font-medium text-slate-700 mb-1">Subject</label>
                                    <select id="student-quiz-subject" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">All Subjects</option>
                                        <option value="MATHS">MATHS</option>
                                        <option value="DBMS">DBMS</option>
                                        <option value="DS">DS</option>
                                        <option value="DLCOA">DLCOA</option>
                                        <option value="DSGT">DSGT</option>
                                    </select>
                                </div>
                            </div>
                            <button id="load-student-quizzes-btn" class="mt-4 bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Load Available Quizzes
                            </button>
                        </div>
                        
                        <!-- Available Quizzes List -->
                        <div id="student-available-quizzes" class="space-y-4">
                            <!-- Available quizzes will be displayed here -->
                        </div>
                        
                        <!-- Quiz Results/History Section -->
                        <div class="mt-8 bg-slate-50 p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800">Your Quiz History</h3>
                                <button id="clear-student-quiz-history-btn" class="text-sm bg-red-600 text-white font-semibold px-3 py-1 rounded-lg hover:bg-red-700 transition-colors">
                                    Clear History
                                </button>
                            </div>
                            <div id="student-quiz-results" class="space-y-3">
                                <!-- Quiz results will be displayed here -->
                                <div class="text-center text-slate-500 py-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-slate-400"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                                    <p class="mt-2">No quiz results yet. Take a quiz to see your performance history!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Quiz Content -->
                <div id="quiz-active-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <button id="back-to-quizzes-btn" class="bg-slate-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
                                ← Back to Quizzes
                            </button>
                            <h2 class="text-2xl font-bold text-slate-800">Quiz in Progress</h2>
                            <div class="flex items-center space-x-4">
                                <div class="text-lg font-semibold text-slate-800">
                                    Time Remaining: <span id="quiz-timer" class="text-red-600">60:00</span>
                                </div>
                                <button id="submit-quiz-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    Submit Quiz
                                </button>
                            </div>
                        </div>
                        <!-- Active Quiz Meta Info -->
                        <div id="active-quiz-info" class="mb-4">
                            <div class="text-slate-700 text-sm">
                                <span class="font-semibold">Quiz:</span>
                                <span id="active-quiz-name" class="ml-1">—</span>
                            </div>
                            <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-700">
                                <span id="active-quiz-branch" class="px-2 py-1 bg-slate-100 rounded">Branch: —</span>
                                <span id="active-quiz-semester" class="px-2 py-1 bg-slate-100 rounded">Semester: —</span>
                                <span id="active-quiz-subject" class="px-2 py-1 bg-slate-100 rounded">Subject: —</span>
                            </div>
                        </div>
                        <div id="quiz-questions-container">
                            <!-- Quiz questions will be dynamically inserted here -->
                        </div>
                        <!-- Quiz Score Container -->
                        <div id="quiz-score-container" class="hidden text-center py-8">
                            <h3 class="text-2xl font-bold text-slate-800 mb-4">Quiz Completed!</h3>
                            <p class="text-xl text-slate-600 mb-6">Your score: <span id="quiz-score" class="font-bold text-blue-600">0</span></p>
                            <button id="retry-quiz-btn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                Retry Quiz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Q&A Page Content -->
                <div id="qa-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- Left Sidebar: Conversations -->
                            <div class="md:col-span-1">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-slate-700">Conversations</h3>
                                    <button id="new-conversation" class="bg-blue-600 text-white text-xs font-semibold px-2.5 py-1.5 rounded-lg hover:bg-blue-700 transition-colors">New</button>
                                </div>
                                <div id="conversation-list" class="space-y-2 max-h-96 overflow-y-auto pr-1"></div>
                            </div>
                            <!-- Chat Area -->
                            <div class="md:col-span-3 flex flex-col">
                                <div id="chat-box" class="h-96 overflow-y-auto mb-4 p-4 bg-slate-50 rounded-lg space-y-4"></div>
                        <div class="flex gap-4">
                            <input type="text" id="question-input" placeholder="Ask a question..." class="flex-grow w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <button id="send-button" class="flex items-center justify-center bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Quizzes functionality removed -->
                
                 <!-- NEW Profile Page Content -->
                <div id="profile-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Edit Your Profile</h2>
                        <form id="profile-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="first-name" class="block text-sm font-medium text-slate-700 mb-1">First Name</label>
                                    <input type="text" id="first-name" placeholder="Karan" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="last-name" class="block text-sm font-medium text-slate-700 mb-1">Last Name</label>
                                    <input type="text" id="last-name" placeholder="Vora" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="student-fields">
                                <div>
                                    <label for="profile-semester" class="block text-sm font-medium text-slate-700 mb-1">Semester</label>
                                    <select id="profile-semester" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option>Semester 1</option>
                                        <option>Semester 2</option>
                                        <option>Semester 3</option>
                                        <option>Semester 4</option>
                                        <option selected>Semester 5</option>
                                        <option>Semester 6</option>
                                        <option>Semester 7</option>
                                        <option>Semester 8</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="profile-branch" class="block text-sm font-medium text-slate-700 mb-1">Branch</label>
                                    <select id="profile-branch" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option>COMPS</option>
                                        <option>IT</option>
                                        <option>AIDS</option>
                                        <option>EXTC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="teacher-fields" style="display: none;">
                                <div>
                                    <label for="profile-department" class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                                    <select id="profile-department" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                        <option>Computer Science</option>
                                        <option>Information Technology</option>
                                        <option>Electronics & Telecommunication</option>
                                        <option>Artificial Intelligence</option>
                                        <option>Mathematics</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="profile-subject" class="block text-sm font-medium text-slate-700 mb-1">Primary Subject</label>
                                    <select id="profile-subject" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                        <option>Data Structures</option>
                                        <option>Database Management</option>
                                        <option>Digital Logic & Computer Organization</option>
                                        <option>Discrete Structures & Graph Theory</option>
                                        <option>Mathematics</option>
                                        <option>Programming Languages</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="teacher-additional-fields" style="display: none;">
                                <div>
                                    <label for="profile-employee-id" class="block text-sm font-medium text-slate-700 mb-1">Employee ID</label>
                                    <input type="text" id="profile-employee-id" placeholder="EMP001" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="profile-years-experience" class="block text-sm font-medium text-slate-700 mb-1">Years of Experience</label>
                                    <select id="profile-years-experience" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                        <option>Select Experience</option>
                                        <option>0-1 years</option>
                                        <option>2-3 years</option>
                                        <option>4-5 years</option>
                                        <option>6-10 years</option>
                                        <option>11-15 years</option>
                                        <option>16-20 years</option>
                                        <option>20+ years</option>
                                    </select>
                                </div>
                            </div>
                            <div id="teacher-hobby-field" style="display: none;">
                                <label for="profile-hobby" class="block text-sm font-medium text-slate-700 mb-1">Hobby</label>
                                <input type="text" id="profile-hobby" placeholder="e.g., Reading, Photography, Music" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="pt-4">
                                <button type="submit" class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>



            </div>
        </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

    <div id="toast-message" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hidden transition-opacity duration-300">
        Profile saved successfully!
    </div>

    <script type="module">
        import { checkApiHealth } from './assets/js/api.js';
        
        document.addEventListener('DOMContentLoaded', async function () {
            // Check API health on startup
            const isApiHealthy = await checkApiHealth();
            if (!isApiHealthy) {
                console.error('[App] API is not responding. Some features may not work.');
                showToast('Warning: Server connection issues. Some features may not work.');
            }
            // --- Auth Guard & User Hydration ---
            async function getCurrentUser() {
                try {
                    // First try to get from localStorage
                    const localUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (localUser) return localUser;
                    
                    // If no local user, try to fetch from API
                    const { authAPI } = await import('./assets/js/api.js');
                    if (authAPI.isAuthenticated()) {
                        const user = await authAPI.getProfile();
                        return user;
                    }
                    return null;
                } catch (e) {
                    console.error('Error getting current user:', e);
                    return null;
                }
            }
            async function hydrateUserUI() {
                const user = await getCurrentUser();
                if (!user) return;
                const firstName = user.firstName || 'Student';
                const lastName = user.lastName || 'User';
                const branch = user.branch || 'COMPS';
                const semester = user.semester || 'Semester 3';
                const role = user.role || 'student';
                const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();

                const profileName = document.getElementById('profile-name');
                const profileDetails = document.getElementById('profile-details');
                const profileAvatar = document.getElementById('profile-avatar');
                const dashName = document.getElementById('dashboard-profile-name');
                const dashDetails = document.getElementById('dashboard-profile-details');
                const dashAvatar = document.getElementById('dashboard-profile-avatar');
                const welcomeMsg = document.getElementById('welcome-message');

                if (profileName) profileName.textContent = `${firstName} ${lastName}`;
                if (profileDetails) {
                    if (role === 'teacher') {
                        const experience = user.yearsExperience || 'Not specified';
                        const hobby = user.hobby || 'Not specified';
                        profileDetails.textContent = `${user.department || 'Computer Science'} • ${experience} • ${hobby}`;
                    } else {
                        profileDetails.textContent = `${branch} • ${semester}`;
                    }
                }
                if (profileAvatar) profileAvatar.src = `https://placehold.co/100x100/7c3aed/ffffff?text=${initials}`;
                if (dashName) dashName.textContent = `${firstName} ${lastName}`;
                if (dashDetails) {
                    if (role === 'teacher') {
                        const experience = user.yearsExperience || 'Not specified';
                        const hobby = user.hobby || 'Not specified';
                        dashDetails.textContent = `${user.department || 'Computer Science'} • ${experience} • ${hobby}`;
                    } else {
                        dashDetails.textContent = `${branch} • ${semester}`;
                    }
                }
                if (dashAvatar) dashAvatar.src = `https://placehold.co/100x100/ffffff/3b82f6?text=${initials}`;
                if (welcomeMsg) welcomeMsg.innerHTML = `Welcome back, ${firstName} ${lastName}! 👋`;

                // Show/hide profile form fields based on role
                const studentFields = document.getElementById('student-fields');
                const teacherFields = document.getElementById('teacher-fields');
                const teacherAdditionalFields = document.getElementById('teacher-additional-fields');
                const teacherHobbyField = document.getElementById('teacher-hobby-field');

                if (role === 'teacher') {
                    if (studentFields) studentFields.style.display = 'none';
                    if (teacherFields) teacherFields.style.display = 'grid';
                    if (teacherAdditionalFields) teacherAdditionalFields.style.display = 'grid';
                    if (teacherHobbyField) teacherHobbyField.style.display = 'block';
                    
                    // Show Contribute Notes link for teachers
                    const contributeNavLink = document.getElementById('contribute-nav-link');
                    if (contributeNavLink) {
                        contributeNavLink.classList.remove('hidden');
                    }
                    
                    // Show Quizzes link for teachers
                    const quizzesNavLink = document.getElementById('quizzes-nav-link');
                    if (quizzesNavLink) {
                        quizzesNavLink.classList.remove('hidden');
                    }
                    
                    // Hide Student Quizzes link for teachers
                    const studentQuizzesNavLink = document.getElementById('student-quizzes-nav-link');
                    if (studentQuizzesNavLink) {
                        studentQuizzesNavLink.classList.add('hidden');
                    }
                    
                    // Show Quizzes stats for teachers (Q&A removed)
                } else {
                    if (studentFields) studentFields.style.display = 'grid';
                    if (teacherFields) teacherFields.style.display = 'none';
                    if (teacherAdditionalFields) teacherAdditionalFields.style.display = 'none';
                    if (teacherHobbyField) teacherHobbyField.style.display = 'none';
                    
                    // Hide Contribute Notes link for students
                    const contributeNavLink = document.getElementById('contribute-nav-link');
                    if (contributeNavLink) {
                        contributeNavLink.classList.add('hidden');
                    }
                    
                    // Hide Quizzes link for students
                    const quizzesNavLink = document.getElementById('quizzes-nav-link');
                    if (quizzesNavLink) {
                        quizzesNavLink.classList.add('hidden');
                    }
                    
                    // Show Student Quizzes link for students
                    const studentQuizzesNavLink = document.getElementById('student-quizzes-nav-link');
                    if (studentQuizzesNavLink) {
                        studentQuizzesNavLink.classList.remove('hidden');
                    }
                    
                    // Hide Quizzes stats for students
                }
            }

            // Function to populate profile form fields
            function populateProfileForm() {
                const user = getCurrentUser();
                if (!user) return;
                
                const role = user.role || 'student';
                
                // Populate common fields
                const firstNameField = document.getElementById('first-name');
                const lastNameField = document.getElementById('last-name');
                if (firstNameField) firstNameField.value = user.firstName || '';
                if (lastNameField) lastNameField.value = user.lastName || '';
                
                if (role === 'teacher') {
                    // Populate teacher fields
                    const departmentField = document.getElementById('profile-department');
                    const subjectField = document.getElementById('profile-subject');
                    const employeeIdField = document.getElementById('profile-employee-id');
                    const yearsExperienceField = document.getElementById('profile-years-experience');
                    const hobbyField = document.getElementById('profile-hobby');
                    
                    if (departmentField) departmentField.value = user.department || '';
                    if (subjectField) subjectField.value = user.subject || '';
                    if (employeeIdField) employeeIdField.value = user.employeeId || '';
                    if (yearsExperienceField) yearsExperienceField.value = user.yearsExperience || '';
                    if (hobbyField) hobbyField.value = user.hobby || '';
                } else {
                    // Populate student fields
                    const semesterField = document.getElementById('profile-semester');
                    const branchField = document.getElementById('profile-branch');
                    
                    if (semesterField) semesterField.value = user.semester || '';
                    if (branchField) branchField.value = user.branch || '';
                }
            }

            const userAtLoad = await getCurrentUser();
            if (!userAtLoad) {
                // Redirect to student login by default
                window.location.href = 'student-login.html';
                return;
            }

            // Initialize UI
            await hydrateUserUI();
            // Ensure dashboard counters reflect latest user and quizzes state on login
            try { updateDashboardQuizCount(); } catch (_) {}

            // Mobile sidebar toggle
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const sidebarClose = document.getElementById('sidebar-close');
            const mainNav = document.getElementById('main-nav');

            function toggleMenu() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }

            if (sidebarClose) {
                sidebarClose.addEventListener('click', toggleMenu);
            }
            if (overlay) {
                overlay.addEventListener('click', toggleMenu);
            }

            // --- Close sidebar on nav link click on mobile ---
            if (mainNav) {
                const navLinks = mainNav.querySelectorAll('a[href^="#"]');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        // If the sidebar is open on a mobile screen, close it
                        if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
                            toggleMenu();
                        }
                    });
                });
            }

            // --- Page Navigation Logic ---
            const contentSections = {
                dashboard: document.getElementById('dashboard-content'),
                library: document.getElementById('library-content'),
                qa: document.getElementById('qa-content'),
                courses: document.getElementById('courses-content'),
                quizzes: document.getElementById('quizzes-content'),
                'student-quizzes': document.getElementById('student-quizzes-content'),
                contribute: document.getElementById('contribute-content'),
                profile: document.getElementById('profile-content'),
            };
            
            const mainHeader = document.getElementById('main-header');

            const headerContent = {
                dashboard: `
                    <div class="flex items-center">
                        <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 id="welcome-message" class="text-2xl sm:text-3xl font-bold text-slate-800">Welcome back, Karan Vora! 👋</h2>
                            <p class="text-slate-500 mt-1">Ready to learn something new today? Here's your personalized dashboard.</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 mt-4 md:mt-0">
                        <a href="qa.html" class="flex items-center justify-center bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:from-blue-700 hover:to-indigo-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2Z"></path>
                            </svg>
                            Ask AI Assistant
                        </a>
                        <a href="#library" class="flex items-center justify-center bg-white text-slate-700 font-semibold px-4 py-2 rounded-lg shadow-md border border-slate-300 hover:bg-slate-50 transition-colors">
                            Browse Library
                        </a>
                    </div>`,
                library: `
                    <div class="flex items-center">
                         <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Resource Library</h2>
                            <p class="text-slate-500 mt-1">Discover notes, PYQs, and study materials for your semester.</p>
                        </div>
                    </div>`,
                qa: `
                    <div class="flex items-center">
                         <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Q&A Assistant</h2>
                            <p class="text-slate-500 mt-1">Ask questions and get answers from your library notes.</p>
                        </div>
                    </div>`,
                courses: `
                    <div class="flex items-center">
                         <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Courses</h2>
                            <p class="text-slate-500 mt-1">Browse our curated course tracks and start learning.</p>
                        </div>
                    </div>`,
                quizzes: `
                    <div class="flex items-center">
                         <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Quiz Management</h2>
                            <p class="text-slate-500 mt-1">Create and manage quizzes for your students.</p>
                        </div>
                    </div>`,
                'student-quizzes': `
                    <div class="flex items-center">
                         <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Available Quizzes</h2>
                            <p class="text-slate-500 mt-1">Take quizzes to test your knowledge.</p>
                        </div>
                    </div>`,
                contribute: `
                    <div class="flex items-center">
                         <button id="menu-toggle-inner" class="lg:hidden -ml-2 mr-2 p-2 rounded-md text-slate-600 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Contribute Notes</h2>
                            <p class="text-slate-500 mt-1">Share educational resources with students.</p>
                        </div>
                    </div>`
            };
            
            function handleNavigation() {
                const hash = window.location.hash || '#dashboard';
                const view = hash.substring(1);

                // Hide all content sections
                Object.values(contentSections).forEach(section => {
                    if (section) section.classList.add('hidden');
                });

                // Show the active one
                if (contentSections[view]) {
                    contentSections[view].classList.remove('hidden');
                    
                    // Populate profile form when profile page is loaded
                    if (view === 'profile') {
                        populateProfileForm();
                    }
                    
                    // Refresh library resources when library page is loaded
                    if (view === 'library') {
                        (async function() {
                            const allResources = await getAllResources();
                            window.resources = allResources;
                            renderResources(allResources);
                            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                            const isTeacher = currentUser?.role === 'teacher';
                            const removeAllBtn = document.getElementById('remove-all-resources');
                            if (removeAllBtn && isTeacher) {
                                removeAllBtn.classList.remove('hidden');
                                removeAllBtn.addEventListener('click', handleRemoveAllResources);
                            }
                        })();
                    }
                    
                    // Initialize quiz management when quizzes page is loaded
                    if (view === 'quizzes') {
                        console.log('Initializing quiz management for quizzes page');
                        setTimeout(initQuizManagement, 100);
                    }
                    
                    // Initialize student quizzes when student-quizzes page is loaded
                    if (view === 'student-quizzes') {
                        console.log('Initializing student quizzes');
                        updateDashboardQuizCount();
                        setTimeout(initStudentQuizzes, 100);
                    }
                    
                    // Handle quiz-active view
                    if (view === 'quiz-active') {
                        console.log('Handling quiz-active view');
                        // Make sure the quiz content is visible
                        const quizActiveContent = document.getElementById('quiz-active-content');
                        if (quizActiveContent) {
                            quizActiveContent.classList.remove('hidden');
                            // Hide all other content sections
                            Object.values(contentSections).forEach(section => {
                                if (section && section !== quizActiveContent) {
                                    section.classList.add('hidden');
                                }
                            });
                        }
                    }
                }

                // Update header
                if (headerContent[view]) {
                    mainHeader.innerHTML = headerContent[view];
                     // Re-attach menu toggle event listener for the new button in the header
                    const newMenuToggle = document.getElementById('menu-toggle-inner');
                    if(newMenuToggle) {
                        newMenuToggle.addEventListener('click', toggleMenu);
                    }
                    hydrateUserUI();
                }
                
                // Update nav link styles
                const navLinks = mainNav.querySelectorAll('a');
                navLinks.forEach(link => {
                    if (link.getAttribute('href').startsWith('#')) {
                        if (link.getAttribute('href') === hash) {
                            link.classList.add('bg-slate-700', 'text-blue-300');
                            link.classList.remove('text-slate-300', 'hover:bg-slate-700');
                        } else {
                            link.classList.remove('bg-slate-700', 'text-blue-300');
                            link.classList.add('text-slate-300', 'hover:bg-slate-700');
                        }
                    }
                });
            }

            // Listen for hash changes (e.g., back/forward buttons)
            window.addEventListener('hashchange', handleNavigation);
            
            // Initial load
            handleNavigation();
            hydrateUserUI();

            // --- Library Data and Filtering Logic ---
            const resources = [
                {
                    title: 'DBMS Assignment 1',
                    subject: 'DBMS',
                    semester: 'Semester 3',
                    type: 'Assignments',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 12',
                    link: '/resources/DBMS/DBMS_Assignment_1.pdf'
                },
                 {
                    title: 'DBMS Module 1: Introduction',
                    subject: 'DBMS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DBMS/DBMS_Module_1.pdf'
                },
                {
                    title: 'DBMS Module 2: Entity-Relationship Model',
                    subject: 'DBMS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DBMS/DBMS_Module_2.pdf'
                },
                {
                    title: 'DBMS Module 3: Relational Model & Algebra',
                    subject: 'DBMS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DBMS/DBMS_Module_3.pdf'
                },
                {
                    title: 'DBMS Module 4: Structured Query Language (SQL)',
                    subject: 'DBMS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    links: [
                        { label: 'View 1', url: '/resources/DBMS/DBMS_Module_4_one.pdf' },
                        { label: 'View 2', url: '/resources/DBMS/DBMS_Module_4_two.pdf' }
                    ]
                },
                {
                    title: 'DBMS Module 5: Relational-Database Design',
                    subject: 'DBMS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DBMS/DBMS_Module_5.pdf'
                },
                {
                    title: 'DLCOA Module 1: Computer Fundamentals',
                    subject: 'DLCOA',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DLCOA/Notes/Module_1.pdf'
                },
                 {
                    title: 'DLCOA Module 2: Data Representation',
                    subject: 'DLCOA',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DLCOA/Notes/Module_2.pdf'
                },
                {
                    title: 'DLCOA Module 3: Processor Organization & Architecture',
                    subject: 'DLCOA',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DLCOA/Notes/Module_3.pdf'
                },
                {
                    title: 'Data Structure Module 1: Introduction',
                    subject: 'Data Structures',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DS/Module_1.pdf'
                },
                {
                    title: 'Data Structure Module 2: Stacks and Queues',
                    subject: 'Data Structures',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DS/Module_2.pdf'
                },
                {
                    title: 'Data Structure Module 3: Linked Lists',
                    subject: 'Data Structures',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DS/Module_3.pdf'
                },
                {
                    title: 'Data Structure Module 4: Trees',
                    subject: 'Data Structures',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DS/Module_4.pdf'
                },
                {
                    title: 'Data Structure Module 5: Graphs',
                    subject: 'Data Structures',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DS/Module_5.pdf'
                },
                {
                    title: 'Data Structure Module 6: Searching Techniques',
                    subject: 'Data Structures',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DS/Module_6.pdf'
                },
                {
                    title: 'Maths Module 1: Laplace Transformation',
                    subject: 'MATHS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/Maths/Module_1.pdf'
                },
                {
                    title: 'Maths Module 2: Inverse Laplace Transform',
                    subject: 'MATHS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/Maths/Module_2.pdf'
                },
                {
                    title: 'Maths Module 3: Fourier Series & Fourier Transform',
                    subject: 'MATHS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/Maths/Module_3.pdf'
                },
                {
                    title: 'Maths Module 4: Complex Variables',
                    subject: 'MATHS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/Maths/Module_4.pdf'
                },
                 {
                    title: 'Maths Module 5: Statistical Techniques',
                    subject: 'MATHS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/Maths/Module_5.pdf'
                },
                {
                    title: 'Maths Module 6: Probability',
                    subject: 'MATHS',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/Maths/Module_6.pdf'
                },
                {
                    title: 'DSGT Module 1: Logic and Proofs',
                    subject: 'DSGT',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DSGT/Module_1.pdf'
                },
                {
                    title: 'DSGT Module 2: Relations & Functions',
                    subject: 'DSGT',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DSGT/Module_2.pdf'
                },
                {
                    title: 'DSGT Module 3: Posets and Lattice',
                    subject: 'DSGT',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DSGT/Module_3.pdf'
                },
                {
                    title: 'DSGT Module 4: Counting',
                    subject: 'DSGT',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DSGT/Module_4.pdf'
                },
                 {
                    title: 'DSGT Module 6: Graph Theory',
                    subject: 'DSGT',
                    semester: 'Semester 3',
                    type: 'Notes',
                    branch: 'COMPS',
                    downloads: 0,
                    date: 'Oct 11',
                    link: '/resources/DSGT/Module_6.pdf'
                },
            ];

            window.resources = resources;
            const staticLinksByTitle = {};
            resources.forEach(r => {
                const l = r.link || (Array.isArray(r.links) && r.links.length > 0 ? r.links[0].url : null);
                if (l) staticLinksByTitle[r.title] = l;
            });

            const libraryGrid = document.getElementById('library-grid');
            const resourceCount = document.getElementById('resource-count');
            const noResultsMessage = document.getElementById('no-results');
            const dashboardResourceCount = document.getElementById('dashboard-resource-count');
            const recentResourcesContainer = document.getElementById('recent-resources-container');
            
            // Load recent resources from localStorage
            let recentlyUsed = [];
            try {
                const stored = localStorage.getItem('recentResources');
                if (stored) {
                    recentlyUsed = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading recent resources:', e);
                recentlyUsed = [];
            }

            function renderResources(filteredResources) {
                if (!libraryGrid) return;
                libraryGrid.innerHTML = ''; // Clear existing cards
                if (filteredResources.length === 0) {
                    noResultsMessage.classList.remove('hidden');
                    libraryGrid.classList.add('hidden');

                } else {
                    noResultsMessage.classList.add('hidden');
                    libraryGrid.classList.remove('hidden');
                    
                    // Get current user role - get from localStorage synchronously
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    const isTeacher = currentUser?.role === 'teacher';
                    
                    console.log('[Library] Rendering resources:', {
                        totalResources: filteredResources.length,
                        isTeacher: isTeacher,
                        currentUser: currentUser
                    });
                    
                    filteredResources.forEach(res => {
                        let buttonsHtml = '';
                        // Handle both static resources (link/links)
                        if (res.links && Array.isArray(res.links)) {
                            buttonsHtml = res.links.map(link => `
                                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white font-semibold px-3 py-1.5 text-xs rounded-lg hover:bg-blue-700 transition-colors ml-2">${link.label}</a>
                            `).join('');
                            if (isTeacher && !res.isUploaded) {
                                buttonsHtml += `<button data-title="${res.title}" class="remove-resource-btn bg-red-600 text-white font-semibold px-3 py-1.5 text-xs rounded-lg hover:bg-red-700 transition-colors ml-2">Remove</button>`;
                            }
                        } else if (res.link) {
                            buttonsHtml = `<a href="${res.link}" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white font-semibold px-3 py-1.5 text-xs rounded-lg hover:bg-blue-700 transition-colors">View</a>`;
                            
                            // Add Remove button for teachers on uploaded resources
                            if (res.isUploaded && res.resourceId && isTeacher) {
                                console.log('[Library] Adding Remove button for:', res.title, {
                                    isUploaded: res.isUploaded,
                                    resourceId: res.resourceId,
                                    isTeacher: isTeacher
                                });
                                buttonsHtml += `<button data-resource-id="${res.resourceId}" class="remove-resource-btn bg-red-600 text-white font-semibold px-3 py-1.5 text-xs rounded-lg hover:bg-red-700 transition-colors ml-2">Remove</button>`;
                            } else if (!res.isUploaded && isTeacher) {
                                buttonsHtml += `<button data-title="${res.title}" class="remove-resource-btn bg-red-600 text-white font-semibold px-3 py-1.5 text-xs rounded-lg hover:bg-red-700 transition-colors ml-2">Remove</button>`;
                            } else if (res.isUploaded) {
                                console.log('[Library] NOT adding Remove button for:', res.title, {
                                    isUploaded: res.isUploaded,
                                    resourceId: res.resourceId,
                                    isTeacher: isTeacher
                                });
                            }
                        }

                        // Handle date formatting
                        const displayDate = res.date || '';

                        const card = `
                            <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col" data-title="${res.title}">
                                <h4 class="font-bold text-slate-800 flex-grow">${res.title}</h4>
                                <div class="flex flex-wrap items-center gap-2 mt-3">
                                    <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-md">${res.subject}</span>
                                    <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-md">${res.semester}</span>
                                    <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded-md">${res.type.toUpperCase()}</span>
                                    <span class="text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded-md">${res.branch}</span>
                                </div>
                                <div class="flex items-center justify-between text-xs text-slate-500 mt-4 pt-4 border-t border-slate-200">
                                    <span>${res.downloads || 0} downloads • ${displayDate}</span>
                                    <div class="flex">${buttonsHtml}</div>
                                </div>
                            </div>
                        `;
                        libraryGrid.insertAdjacentHTML('beforeend', card);
                    });
                }
                 resourceCount.textContent = `Showing ${filteredResources.length} of ${(window.resources || resources).length} resources`;
                 if (dashboardResourceCount) {
                     dashboardResourceCount.textContent = (window.resources || resources).length;
                 }
            }
            
            function renderRecentResources() {
                if (!recentResourcesContainer) return;
                if (recentlyUsed.length === 0) {
                    recentResourcesContainer.innerHTML = '<p class="text-slate-500">No resources viewed recently. Go to the library to start exploring!</p>';
                } else {
                    recentResourcesContainer.innerHTML = '';
                    
                    // Show only first 2 items in dashboard
                    const displayItems = recentlyUsed.slice(0, 2);
                    displayItems.forEach((res, index) => {
                        const item = `
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border rounded-lg hover:bg-slate-50">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-slate-700">${res.title}</h4>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <span class="text-xs font-medium text-slate-600 bg-slate-200 px-2 py-1 rounded-md">${res.subject}</span>
                                        <span class="text-xs font-medium text-slate-600 bg-slate-200 px-2 py-1 rounded-md">${res.semester}</span>
                                        <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded-md">${res.type.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 mt-4 sm:mt-0">
                                    <a href="${res.link || res.links[0].url}" target="_blank" rel="noopener noreferrer" class="bg-white text-slate-700 font-semibold px-4 py-2 text-sm rounded-lg shadow-sm border border-slate-300 hover:bg-slate-100 transition-colors">View</a>
                                    <button data-recent-index="${index}" class="remove-recent-btn bg-red-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-red-700 transition-colors">Clear</button>
                                </div>
                            </div>
                        `;
                        recentResourcesContainer.insertAdjacentHTML('beforeend', item);
                    });
                    
                    // Add "View All" button if there are more than 2 resources
                    if (recentlyUsed.length > 2) {
                        const viewAllBtn = `
                            <button id="view-all-recent-btn" class="w-full mt-4 bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                View All (${recentlyUsed.length} resources)
                            </button>
                        `;
                        recentResourcesContainer.insertAdjacentHTML('beforeend', viewAllBtn);
                    }
                }
            }
            
            function addRecentResource(resource) {
                recentlyUsed = recentlyUsed.filter(item => item.title !== resource.title);
                recentlyUsed.unshift(resource);
                // No limit - keep all viewed resources
                // Save to localStorage
                localStorage.setItem('recentResources', JSON.stringify(recentlyUsed));
                renderRecentResources();
            }
            
            // Remove item from recent resources
            function removeRecentResource(index) {
                recentlyUsed.splice(index, 1);
                // Save to localStorage
                localStorage.setItem('recentResources', JSON.stringify(recentlyUsed));
                renderRecentResources();
            }
            
            // Event delegation for recent resources remove button
            if (recentResourcesContainer) {
                recentResourcesContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-recent-btn');
                    if (removeBtn) {
                        e.preventDefault();
                        const index = parseInt(removeBtn.dataset.recentIndex);
                        removeRecentResource(index);
                        return;
                    }
                    
                    // View All button click
                    if (e.target.closest('#view-all-recent-btn')) {
                        e.preventDefault();
                        showAllRecentResourcesModal();
                        return;
                    }
                });
            }
            
            // Show modal with all recent resources
            function showAllRecentResourcesModal() {
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'recent-resources-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <!-- Modal Header -->
                        <div class="flex items-center justify-between p-6 border-b border-slate-200">
                            <h3 class="text-2xl font-bold text-slate-800">All Recent Resources</h3>
                            <button id="close-recent-modal" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Modal Content -->
                        <div class="flex-1 overflow-y-auto p-6">
                            <div id="modal-recent-resources-list" class="space-y-4"></div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Render all resources in modal
                const modalList = document.getElementById('modal-recent-resources-list');
                recentlyUsed.forEach((res, index) => {
                    const item = `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border rounded-lg hover:bg-slate-50">
                            <div class="flex-1">
                                <h4 class="font-semibold text-slate-700">${res.title}</h4>
                                <div class="flex items-center space-x-2 mt-2">
                                    <span class="text-xs font-medium text-slate-600 bg-slate-200 px-2 py-1 rounded-md">${res.subject}</span>
                                    <span class="text-xs font-medium text-slate-600 bg-slate-200 px-2 py-1 rounded-md">${res.semester}</span>
                                    <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded-md">${res.type.toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mt-4 sm:mt-0">
                                <a href="${res.link || res.links[0].url}" target="_blank" rel="noopener noreferrer" class="bg-white text-slate-700 font-semibold px-4 py-2 text-sm rounded-lg shadow-sm border border-slate-300 hover:bg-slate-100 transition-colors">View</a>
                                <button data-modal-recent-index="${index}" class="remove-modal-recent-btn bg-red-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-red-700 transition-colors">Clear</button>
                            </div>
                        </div>
                    `;
                    modalList.insertAdjacentHTML('beforeend', item);
                });
                
                // Close modal handlers
                const closeModalBtn = document.getElementById('close-recent-modal');
                closeModalBtn.addEventListener('click', closeRecentModal);
                
                // Close on backdrop click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeRecentModal();
                    }
                });
                
                // Handle clear buttons in modal
                modalList.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-modal-recent-btn');
                    if (removeBtn) {
                        e.preventDefault();
                        const index = parseInt(removeBtn.dataset.modalRecentIndex);
                        removeRecentResource(index);
                        // Refresh modal content
                        closeRecentModal();
                        if (recentlyUsed.length > 2) {
                            showAllRecentResourcesModal();
                        }
                        return;
                    }
                });
            }
            
            // Close modal
            function closeRecentModal() {
                const modal = document.getElementById('recent-resources-modal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // Event delegation for library view clicks
            if (libraryGrid) {
                libraryGrid.addEventListener('click', function(e) {
                    // Remove button clicks
                    if (e.target.classList.contains('remove-resource-btn')) {
                        e.preventDefault();
                        const resourceId = e.target.dataset.resourceId;
                        const title = e.target.dataset.title;
                        if (resourceId) {
                            handleRemoveResource(resourceId);
                        } else if (title) {
                            handleRemoveStaticResource(title);
                        }
                        return;
                    }
                    
                    // View clicks
                    if (e.target.tagName === 'A' && e.target.textContent.includes('View')) {
                        const card = e.target.closest('.bg-white');
                        const title = card.dataset.title;
                        const resource = (window.resources || resources).find(r => r.title === title);
                        if (resource) {
                            addRecentResource(resource);
                        }
                        return;
                    }
                });
            }
            
            // Handle resource removal
            async function handleRemoveResource(resourceId) {
                if (!confirm('Are you sure you want to remove this resource? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    const { apiRequest } = await import('./assets/js/api.js');
                    await apiRequest(`/resources/${resourceId}`, {
                        method: 'DELETE'
                    });
                    
                    // Refresh the library to show updated list
                    const allResources = await getAllResources();
                    window.resources = allResources;
                    renderResources(allResources);
                    
                    // Show success message
                    showToast('Resource removed successfully!');
                } catch (error) {
                    console.error('Error removing resource:', error);
                    alert('Failed to remove resource. Please try again.');
                }
            }

            function handleRemoveStaticResource(title) {
                if (!confirm('Are you sure you want to remove this resource? This action cannot be undone.')) {
                    return;
                }
                const key = 'removedStaticResources';
                let removed = [];
                try {
                    const stored = localStorage.getItem(key);
                    if (stored) removed = JSON.parse(stored);
                } catch (e) {
                    removed = [];
                }
                if (!removed.includes(title)) {
                    removed.push(title);
                    localStorage.setItem(key, JSON.stringify(removed));
                }
                (async function() {
                    const allResources = await getAllResources();
                    window.resources = allResources;
                    renderResources(allResources);
                    showToast('Resource removed successfully!');
                })();
            }

            async function handleRemoveAllResources() {
                if (!confirm('Remove all resources? This will delete uploaded items and hide defaults.')) {
                    return;
                }
                try {
                    const { apiRequest } = await import('./assets/js/api.js');
                    const all = window.resources || await getAllResources();
                    const uploaded = all.filter(r => r.isUploaded && r.resourceId);
                    const staticTitles = (resources || []).map(r => r.title);
                    await Promise.all(uploaded.map(r => apiRequest(`/resources/${r.resourceId}`, { method: 'DELETE' }).catch(() => null)));
                    localStorage.setItem('removedStaticResources', JSON.stringify(staticTitles));
                    const refreshed = await getAllResources();
                    window.resources = refreshed;
                    renderResources(refreshed);
                    showToast('All resources removed');
                } catch (err) {
                    alert('Failed to remove all resources. Please try again.');
                }
            }

            // Initial render - Load all resources including uploaded ones
            (async function() {
                const allResources = await getAllResources();
                window.resources = allResources; // Store globally
                renderResources(allResources);
                renderRecentResources();
            })();


            // --- Dynamic Subject Filtering ---
            const semesterSelect = document.getElementById('semester-select');
            const subjectSelect = document.getElementById('subject-select');

            const semesterSubjects = {
                "Semester 3": ["DLCOA", "DSGT", "DBMS", "MATHS", "Data Structures"]
            };

            function updateSubjectOptions(subjects) {
                if(!subjectSelect) return;
                subjectSelect.innerHTML = '<option>All Subjects</option>';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
            }
            
            if (semesterSelect && subjectSelect) {
                semesterSelect.addEventListener('change', (event) => {
                    const selectedSemester = event.target.value;
                    if (semesterSubjects[selectedSemester]) {
                        updateSubjectOptions(semesterSubjects[selectedSemester]);
                    } else {
                        updateSubjectOptions([]);
                    }
                     filterResources();
                });
            }

            const filters = document.querySelectorAll('#library-content select, #library-content input[type="text"]');
            filters.forEach(filter => {
                filter.addEventListener('change', filterResources);
                if(filter.type === 'text') {
                    filter.addEventListener('keyup', filterResources);
                }
            });

            function filterResources() {
                 if (!libraryGrid) return;
                const searchTerm = document.querySelector('#library-content input[type="text"]').value.toLowerCase();
                const selectedSemester = document.getElementById('semester-select').value;
                const selectedSubject = document.getElementById('subject-select').value;
                const selectedType = document.getElementById('type-select').value;
                const selectedBranch = document.getElementById('branch-select').value;
                
                const allResources = window.resources || resources;
                const filtered = allResources.filter(res => {
                    const matchesSearch = res.title.toLowerCase().includes(searchTerm);
                    const matchesSemester = selectedSemester === 'All Semesters' || res.semester === selectedSemester;
                    const matchesSubject = selectedSubject === 'All Subjects' || res.subject === selectedSubject;
                    const matchesType = selectedType === 'All Types' || res.type === selectedType;
                    const matchesBranch = selectedBranch === 'All Branches' || res.branch === selectedBranch;

                    return matchesSearch && matchesSemester && matchesSubject && matchesType && matchesBranch;
                });
                
                renderResources(filtered);
            }

            // --- Q&A Logic ---
            (function qaLogic(){
                const chatBox = document.getElementById('chat-box');
                const inputEl = document.getElementById('question-input');
                const sendBtn = document.getElementById('send-button');
                const convList = document.getElementById('conversation-list');
                const newConvBtn = document.getElementById('new-conversation');
                const API_BASE = 'http://localhost:3200/api/';
                let apiHealthy = false;

                function getUserId(){
                    try { return (JSON.parse(localStorage.getItem('currentUser'))||{}).id || 'guest'; } catch(e){ return 'guest'; }
                }
                function storageKey(){ return `qa_conversations_${getUserId()}`; }
                async function checkApi(){
                    try {
                        const res = await fetch(API_BASE + '/health', { method: 'GET' });
                        apiHealthy = res.ok;
                    } catch (_) { apiHealthy = false; }
                }

                function loadConversations(){
                    try { return JSON.parse(localStorage.getItem(storageKey())) || []; } catch(e){ return []; }
                }
                function saveConversations(conversations){
                    localStorage.setItem(storageKey(), JSON.stringify(conversations));
                }
                async function fetchConversations(){
                    if (!apiHealthy) return loadConversations();
                    try {
                        const res = await fetch(`${API_BASE}/conversations?userId=${encodeURIComponent(getUserId())}`);
                        if (!res.ok) throw new Error('bad');
                        const data = await res.json();
                        // also cache locally
                        saveConversations(data);
                        return data;
                    } catch (_) {
                        return loadConversations();
                    }
                }
                async function createConversationRemote(conv){
                    if (!apiHealthy) return;
                    try {
                        await fetch(`${API_BASE}/conversations`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getUserId(), ...conv }) });
                    } catch(_){}
                }
                async function updateConversationRemote(conv){
                    if (!apiHealthy) return;
                    try {
                        await fetch(`${API_BASE}/conversations/${encodeURIComponent(conv.id)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getUserId(), ...conv }) });
                    } catch(_){}
                }
                async function deleteConversationRemote(id){
                    if (!apiHealthy) return;
                    try {
                        await fetch(`${API_BASE}/conversations/${encodeURIComponent(id)}?userId=${encodeURIComponent(getUserId())}`, { method: 'DELETE' });
                    } catch(_){}
                }
                function ensureDefaultConversation(){
                    let conversations = loadConversations();
                    if(conversations.length === 0){
                        conversations = [{ id: Date.now().toString(), title: 'Conversation 1', messages: [] }];
                        saveConversations(conversations);
                        localStorage.setItem('qa_active_conversation', conversations[0].id);
                    }
                    return conversations;
                }
                function getActiveConversationId(){
                    return localStorage.getItem('qa_active_conversation');
                }
                function setActiveConversationId(id){
                    localStorage.setItem('qa_active_conversation', id);
                }
                function renderConversationList(){
                    const conversations = ensureDefaultConversation();
                    const activeId = getActiveConversationId() || conversations[0].id;
                    if(!convList) return;
                    convList.innerHTML = '';
                    conversations.forEach(c => {
                        const row = document.createElement('div');
                        row.className = `flex items-center gap-2 px-2 py-2 rounded-lg border ${c.id===activeId ? 'bg-blue-50 border-blue-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`;
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = `flex-1 text-left text-sm ${c.id===activeId ? 'text-blue-800' : 'text-slate-700'}`;
                        btn.textContent = c.title || 'Conversation';
                        btn.addEventListener('click', ()=>{ setActiveConversationId(c.id); renderConversationList(); renderMessages(); });
                        const del = document.createElement('button');
                        del.type = 'button';
                        del.className = 'text-slate-500 hover:text-red-600 text-xs font-semibold px-2 py-1 rounded';
                        del.textContent = 'Delete';
                        del.addEventListener('click', async (e)=>{
                            e.stopPropagation();
                            const conversations = loadConversations();
                            const filtered = conversations.filter(x => x.id !== c.id);
                            saveConversations(filtered);
                            await deleteConversationRemote(c.id);
                            const next = filtered[0];
                            if (next) setActiveConversationId(next.id); else localStorage.removeItem('qa_active_conversation');
                            renderConversationList();
                            renderMessages();
                        });
                        row.appendChild(btn);
                        row.appendChild(del);
                        convList.appendChild(row);
                    });
                }
                function renderMessages(){
                    const conversations = ensureDefaultConversation();
                    const activeId = getActiveConversationId() || conversations[0].id;
                    const conv = conversations.find(c => c.id === activeId) || conversations[0];
                    if(!conv) return;
                    chatBox.innerHTML = '';
                    if(conv.messages.length === 0){
                        const welcome = document.createElement('div');
                        welcome.className = 'flex items-start gap-3';
                        welcome.innerHTML = `
                            <div class="bg-blue-600 text-white rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center font-bold text-sm">CR</div>
                            <div class="bg-slate-200 p-3 rounded-lg rounded-tl-none">
                                <p class="text-sm text-slate-800">Hello! I'm your ClassReconnect assistant. Ask me anything about your course material, and I'll do my best to provide a clear, step-by-step answer.</p>
                            </div>`;
                        chatBox.appendChild(welcome);
                    } else {
                        conv.messages.forEach(m => {
                            const row = document.createElement('div');
                            if(m.role === 'user'){
                                row.className = 'flex items-start gap-3 justify-end';
                                row.innerHTML = `
                                    <div class="bg-blue-600 text-white p-3 rounded-lg rounded-tr-none max-w-[80%]"><p class="text-sm">${m.text}</p></div>`;
                            } else {
                                row.className = 'flex items-start gap-3';
                                row.innerHTML = `
                                    <div class="bg-blue-600 text-white rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center font-bold text-sm">CR</div>
                                    <div class="bg-slate-200 p-3 rounded-lg rounded-tl-none max-w-[80%]"><p class="text-sm text-slate-800">${m.text}</p></div>`;
                            }
                            chatBox.appendChild(row);
                        });
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
                function appendMessage(role, text){
                    const conversations = ensureDefaultConversation();
                    const activeId = getActiveConversationId() || conversations[0].id;
                    const idx = conversations.findIndex(c => c.id === activeId);
                    if(idx === -1) return;
                    const message = { role, text, ts: Date.now() };
                    conversations[idx].messages.push(message);
                    // Set title from first user message if default title
                    if(conversations[idx].messages.length === 1 && role === 'user'){
                        conversations[idx].title = text.slice(0, 30) || conversations[idx].title;
                    }
                    saveConversations(conversations);
                }
                async function handleSend(){
                    const text = (inputEl.value || '').trim();
                    if(!text) return;
                    appendMessage('user', text);
                    inputEl.value = '';
                    renderConversationList();
                    renderMessages();
                    // Call backend ChatGPT with conversation history for follow-ups
                    const conversations = loadConversations();
                    const activeId = getActiveConversationId();
                    const conv = conversations.find(c => c.id === activeId) || conversations[0];
                    if (apiHealthy && conv) {
                        try {
                            const latest = conv.messages[conv.messages.length - 1]?.text || '';
                            const res = await fetch(`${API_BASE}/qa/answer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: latest }) });
                            if (res.ok) {
                                const data = await res.json();
                                appendMessage('assistant', data.answer || '');
                                renderMessages();
                                await updateConversationRemote({ id: conv.id, title: conv.title, messages: (loadConversations().find(c=>c.id===conv.id)||conv).messages });
                                return;
                            }
                        } catch(_){}
                    }
                    // No fallback message; assistant requires AI backend
                }
                function startNewConversation(){
                    const conversations = loadConversations();
                    const id = Date.now().toString();
                    const conv = { id, title: `Conversation ${conversations.length + 1}`, messages: [] };
                    conversations.unshift(conv);
                    saveConversations(conversations);
                    createConversationRemote(conv);
                    setActiveConversationId(id);
                    renderConversationList();
                    renderMessages();
                }

                // Initialize
                (async function init(){
                    await checkApi();
                    const remote = await fetchConversations();
                    if (remote && remote.length) saveConversations(remote);
                    ensureDefaultConversation();
                })();
                if(!getActiveConversationId()){
                    const convs = loadConversations();
                    if(convs[0]) setActiveConversationId(convs[0].id);
                }
                renderConversationList();
                renderMessages();

                // Events
                sendBtn && sendBtn.addEventListener('click', handleSend);
                inputEl && inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleSend(); }});
                newConvBtn && newConvBtn.addEventListener('click', startNewConversation);
            })();
            
            // Quiz functionality removed
            
            // --- Profile Page Logic ---
            function showToast(message) {
                const toast = document.getElementById('toast-message');
                toast.textContent = message;
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }

            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const user = getCurrentUser();
                    const role = user?.role || 'student';
                    
                    const firstName = document.getElementById('first-name').value || 'Student';
                    const lastName = document.getElementById('last-name').value || 'User';
                    
                    let updatedUser = {
                        ...user,
                        firstName,
                        lastName
                    };

                    if (role === 'teacher') {
                        const department = document.getElementById('profile-department').value;
                        const subject = document.getElementById('profile-subject').value;
                        const employeeId = document.getElementById('profile-employee-id').value;
                        const yearsExperience = document.getElementById('profile-years-experience').value;
                        const hobby = document.getElementById('profile-hobby').value;

                        updatedUser = {
                            ...updatedUser,
                            department,
                            subject,
                            employeeId,
                            yearsExperience,
                            hobby
                        };

                        // Update sidebar profile
                        document.getElementById('profile-name').textContent = `${firstName} ${lastName}`;
                        const experience = yearsExperience || 'Not specified';
                        const hobbyText = hobby || 'Not specified';
                        document.getElementById('profile-details').textContent = `${department} • ${experience} • ${hobbyText}`;
                        
                        // Update dashboard profile card
                        document.getElementById('dashboard-profile-name').textContent = `${firstName} ${lastName}`;
                        document.getElementById('dashboard-profile-details').textContent = `${department} • ${experience} • ${hobbyText}`;
                    } else {
                        const semester = document.getElementById('profile-semester').value;
                        const branch = document.getElementById('profile-branch').value;

                        updatedUser = {
                            ...updatedUser,
                            semester,
                            branch
                        };

                        // Update sidebar profile
                        document.getElementById('profile-name').textContent = `${firstName} ${lastName}`;
                        document.getElementById('profile-details').textContent = `${branch} • ${semester}`;
                        
                        // Update dashboard profile card
                        document.getElementById('dashboard-profile-name').textContent = `${firstName} ${lastName}`;
                        document.getElementById('dashboard-profile-details').textContent = `${branch} • ${semester}`;
                    }
                    
                    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                    document.getElementById('profile-avatar').src = `https://placehold.co/100x100/7c3aed/ffffff?text=${initials}`;
                    document.getElementById('dashboard-profile-avatar').src = `https://placehold.co/100x100/ffffff/3b82f6?text=${initials}`;
                    
                    const welcomeMsg = document.getElementById('welcome-message');
                    if(welcomeMsg) {
                        welcomeMsg.innerHTML = `Welcome back, ${firstName} ${lastName}! 👋`;
                    }
                    
                    // Persist back to session
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    try { updateDashboardQuizCount(); } catch (_) {}
                    showToast('Profile saved successfully!');
                });
            }

            // --- Logout ---
            const logoutBtn = document.getElementById('logout-button');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    // Use centralized logout helper which reads role before clearing storage
                    const { logoutAndRedirect } = await import('./assets/js/api.js');
                    logoutAndRedirect();
                });
            }

            // Enroll button handling
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target && target.classList && target.classList.contains('enroll-btn')) {
                    const course = target.getAttribute('data-course') || 'Course';
                    showToast(`Enrolled in ${course}!`);
                }
            });
            
            // --- Contribute Notes Form Handler ---
            const contributeForm = document.getElementById('contribute-form');
            if (contributeForm) {
                contributeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const uploadBtn = document.getElementById('upload-resource-btn');
                    const uploadStatus = document.getElementById('upload-status');
                    const originalBtnText = uploadBtn.innerHTML;
                    
                    try {
                        // Show loading state
                        uploadBtn.disabled = true;
                        uploadBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Uploading...';
                        
                        // Get form values
                        const branch = document.getElementById('contribute-branch').value;
                        const semester = document.getElementById('contribute-semester').value;
                        const subject = document.getElementById('contribute-subject').value;
                        const type = document.getElementById('contribute-type').value;
                        const title = document.getElementById('contribute-title').value;
                        const description = document.getElementById('contribute-description').value;
                        const fileInput = document.getElementById('contribute-file');
                        const file = fileInput.files[0];
                        
                        if (!file) {
                            throw new Error('Please select a file to upload');
                        }
                        
                        // Create FormData
                        const formData = new FormData();
                        formData.append('title', title);
                        formData.append('subject', subject);
                        formData.append('semester', semester);
                        formData.append('type', type);
                        formData.append('branch', branch);
                        formData.append('description', description);
                        formData.append('file', file);
                            
                        // Upload to backend
                        const { apiRequest } = await import('./assets/js/api.js');
                        const response = await apiRequest('/resources/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        // Show success message
                        uploadStatus.className = 'mt-4 p-4 rounded-lg bg-green-50 border border-green-200';
                        uploadStatus.innerHTML = '<p class="text-green-800 font-semibold">✓ Resource uploaded successfully!</p>';
                        uploadStatus.classList.remove('hidden');
                        
                        // Reset form
                        contributeForm.reset();
                        
                        // Redirect to library after 1.5 seconds
                        setTimeout(() => {
                            window.location.hash = '#library';
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Upload error:', error);
                        uploadStatus.className = 'mt-4 p-4 rounded-lg bg-red-50 border border-red-200';
                        uploadStatus.innerHTML = `<p class="text-red-800 font-semibold">✗ ${error.message || 'Failed to upload resource. Please try again.'}</p>`;
                        uploadStatus.classList.remove('hidden');
                    } finally {
                        // Restore button
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = originalBtnText;
                        
                        // Hide status after 5 seconds
                        setTimeout(() => {
                            uploadStatus.classList.add('hidden');
                        }, 5000);
                    }
                });
            }
            
            // --- Fetch and Display Backend Resources ---
            async function fetchBackendResources() {
                try {
                    const { apiRequest } = await import('./assets/js/api.js');
                    const response = await apiRequest('/resources');
                    return response.resources || [];
                } catch (error) {
                    console.error('Error fetching resources:', error);
                    return [];
                }
            }
            
            async function fetchDeletedDefaultTitles() {
                try {
                    const { apiRequest } = await import('./assets/js/api.js');
                    const response = await apiRequest('/resources/deleted-defaults');
                    const titles = (response && response.titles) ? response.titles : [];
                    return new Set(titles);
                } catch (error) {
                    console.warn('Error fetching deleted defaults:', error);
                    return new Set();
                }
            }
            
            // Merge backend resources with static resources
            async function getAllResources() {
                const backendResources = await fetchBackendResources();
                const deletedDefaultTitles = await fetchDeletedDefaultTitles();
                const currentUser = getCurrentUser();
                
                console.log('[getAllResources] Fetched backend resources:', {
                    count: backendResources.length,
                    currentUser: currentUser
                });
                
                // Transform backend resources to match the static format
                const transformedResources = backendResources.map(resource => {
                    const uploadDate = new Date(resource.uploadedAt);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const dateStr = `${monthNames[uploadDate.getMonth()]} ${uploadDate.getDate()}`;
                    
                    // Extract filename from path (handles both Windows and Unix paths)
                    const filename = resource.filePath.split(/[\\/]/).pop();
                    
                    const defaultUploadsLink = `http://localhost:3000/uploads/${filename}`;
                    const fallbackStaticLink = staticLinksByTitle[resource.title] || null;
                    const transformed = {
                        title: resource.title,
                        subject: resource.subject,
                        semester: resource.semester,
                        type: resource.type,
                        branch: resource.branch,
                        downloads: resource.downloads || 0,
                        date: dateStr,
                        link: fallbackStaticLink || defaultUploadsLink,
                        description: resource.description,
                        isUploaded: true,
                        resourceId: resource._id
                    };
                    
                    console.log('[getAllResources] Transformed resource:', transformed.title, transformed);
                    return transformed;
                });
                
                console.log('[getAllResources] Total transformed:', transformedResources.length);
                
                // Combine with static resources (put uploaded ones first)
                let removed = [];
                try {
                    const stored = localStorage.getItem('removedStaticResources');
                    if (stored) removed = JSON.parse(stored);
                } catch (e) {
                    removed = [];
                }
                const backendTitles = new Set(transformedResources.map(r => r.title));
                const filteredStatic = resources.filter(r => !removed.includes(r.title) && !backendTitles.has(r.title) && !deletedDefaultTitles.has(r.title));
                return [...transformedResources, ...filteredStatic];
            }
            
            // --- Quiz Management Logic ---
            function initQuizManagement() {
                // Initialize sample quizzes only once per device/session
                const sampleInitialized = localStorage.getItem('sampleQuizzesInitialized') === 'true';
                if (!sampleInitialized) {
                    initSampleQuizzes();
                }
                
                // Clear form fields
                document.getElementById('create-quiz-form').reset();
                
                // Also clear the submit button if it's in update mode
                const submitButton = document.getElementById('create-quiz-btn');
                if (submitButton && submitButton.textContent.trim() === 'Update Quiz') {
                    submitButton.textContent = 'Create Quiz';
                    submitButton.removeAttribute('data-quiz-id');
                }
                
                const createQuizForm = document.getElementById('create-quiz-form');
                if (createQuizForm && !createQuizForm.dataset.listenerAttached) {
                    createQuizForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        createQuiz();
                    });
                    createQuizForm.dataset.listenerAttached = 'true';
                }
                
                // View Quiz functionality
                const viewQuizBtn = document.getElementById('view-quiz-btn');
                if (viewQuizBtn) {
                    viewQuizBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        viewQuizzes();
                    });
                }
                
                // Add event listeners to view quiz filters
                const viewQuizBranch = document.getElementById('view-quiz-branch');
                const viewQuizSemester = document.getElementById('view-quiz-semester');
                const viewQuizSubject = document.getElementById('view-quiz-subject');
                
                if (viewQuizBranch) {
                    viewQuizBranch.addEventListener('change', viewQuizzes);
                }
                if (viewQuizSemester) {
                    viewQuizSemester.addEventListener('change', viewQuizzes);
                }
                if (viewQuizSubject) {
                    viewQuizSubject.addEventListener('change', viewQuizzes);
                }                viewQuizzes();
            }
            
            function loadQuizzes() {
                const quizzesList = document.getElementById('quizzes-list');
                if (!quizzesList) return;
                
                // Get filter values
                const filterBranch = document.getElementById('quiz-filter-branch')?.value || '';
                const filterSemester = document.getElementById('quiz-filter-semester')?.value || '';
                const filterSubject = document.getElementById('quiz-filter-subject')?.value || '';
                
                // Get quizzes from localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                
                // Apply filters
                quizzes = quizzes.filter(quiz => {
                    const matchesBranch = !filterBranch || quiz.branch === filterBranch;
                    const matchesSemester = !filterSemester || quiz.semester === filterSemester;
                    const matchesSubject = !filterSubject || quiz.subject === filterSubject;
                    return matchesBranch && matchesSemester && matchesSubject;
                });
                
                // Display quizzes
                if (quizzes.length === 0) {
                    quizzesList.innerHTML = `
                        <div class="text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-slate-400"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                            <h3 class="mt-2 text-lg font-semibold text-slate-800">No quizzes found</h3>
                            <p class="mt-1 text-sm text-slate-500">Try adjusting your filter criteria or create your first quiz using the form above.</p>
                        </div>
                    `;
                } else {
                    quizzesList.innerHTML = quizzes.map(quiz => `
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-slate-800">${quiz.name}</h3>
                                    <div class="flex flex-wrap items-center gap-2 mt-2">
                                        <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-md">${quiz.subject}</span>
                                        <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-md">${quiz.semester}</span>
                                        <span class="text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded-md">${quiz.branch}</span>
                                        <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded-md">${quiz.numQuestions} questions</span>
                                        <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded-md">${quiz.duration} min</span>
                                        ${quiz.setPaper ? `<span class="text-xs font-medium text-orange-700 bg-orange-100 px-2 py-1 rounded-md">${quiz.setPaper}</span>` : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-2">Created: ${new Date(quiz.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="start-quiz-btn bg-green-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-green-700 transition-colors" data-quiz-id="${quiz.id}">
                                        Start Quiz
                                    </button>
                                    <button class="delete-quiz-btn bg-red-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-red-700 transition-colors" data-quiz-id="${quiz.id}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners to the start quiz buttons with improved handling
                    // Use a more reliable approach to ensure event listeners are attached
                    setTimeout(() => {
                        const buttons = document.querySelectorAll('.start-quiz-btn');
                        console.log('Found', buttons.length, 'start quiz buttons for teachers');
                        
                        buttons.forEach(button => {
                            // Get the quiz ID
                            const quizId = button.getAttribute('data-quiz-id');
                            console.log('Attaching event listener to teacher button for quiz ID:', quizId);
                            
                            // Remove any existing event listeners by cloning and replacing
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                            
                            // Create a new event listener function
                            const clickHandler = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Start Quiz button clicked for quiz ID:', quizId);
                                startQuiz(quizId);
                            };
                            
                            // Add the click event listener
                        newButton.addEventListener('click', clickHandler);
                    });
                    
                    // Add event listeners to the delete quiz buttons
                    const deleteButtons = document.querySelectorAll('.delete-quiz-btn');
                    console.log('Found', deleteButtons.length, 'delete quiz buttons');
                    
                    deleteButtons.forEach(button => {
                        // Get the quiz ID
                        const quizId = button.getAttribute('data-quiz-id');
                        console.log('Attaching event listener to delete button for quiz ID:', quizId);
                        
                        // Remove any existing event listeners by cloning and replacing
                        const newButton = button.cloneNode(true);
                        button.parentNode.replaceChild(newButton, button);
                        
                        // Create a new event listener function
                        const clickHandler = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Delete Quiz button clicked for quiz ID:', quizId);
                            deleteQuiz(quizId);
                        };
                        
                        // Add the click event listener
                        newButton.addEventListener('click', clickHandler);
                    });
                }, 150);
                }
            }
            
            function startQuiz(quizId) {
                // Get the quiz data from localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                const quiz = quizzes.find(q => q.id === quizId);
                
                if (!quiz) {
                    alert('Quiz not found!');
                    return;
                }
                
                // Special handling for Maths Quiz - Set A (restrict to MATHS subject)
                if ((quiz.name && quiz.name === 'Maths Quiz - Set A') || (quiz.subject === 'MATHS' && quiz.setPaper === 'Set A')) {
                    // Load questions from setA.py
                    const setAQuiz = {
                        id: quizId,
                        name: quiz.name || 'Maths Quiz - Set A',
                        duration: quiz.duration || 30,
                        branch: quiz.branch || 'COMPS',
                        semester: quiz.semester || 'Semester 3',
                        subject: quiz.subject || 'MATHS',
                        numQuestions: 5,
                        setPaper: 'Set A',
                        questions: [
                            {
                                question: "Compute Spearman’s rank correlation coefficient from the following data:\nX: 40, 42, 45, 35, 36, 39 \nY: 46, 43, 44, 39, 40, 43",
                                options: ["0.7714", "0.7614", "0", "0.78"],
                                correctAnswer: 0,
                                solutionSteps: [
                                    "Step 1: Calculate the ranks of X and Y and find d and  \(d^{2}\)",
                                    "|  i | (Rx) | (Ry) | (d=Rx-Ry) | ( \(d^{2}\)) |",
                                    "|  1 |  4.0 |  6.0 |   -2.0    |      4.00    |",
                                    "|  2 |  5.0 |  3.5 |    1.5    |      2.25    |",
                                    "|  3 |  6.0 |  5.0 |    1.0    |      1.00    |",
                                    "|  4 |  1.0 |  1.0 |    0.0    |      0.00    |",
                                    "|  5 |  2.0 |  2.0 |    0.0    |      0.00    |",
                                    "|  6 |  3.0 |  3.5 |   -0.5    |      0.25    |",
                                    "Step 2: Calculate Summation of \(d^{2}\) : ∑\(d^{2}\) = 4 + 2.25 + 1 + 0 + 0 + 0.25 = 7.5",
                                    "Step 3: Calculate Spearman rank correlation coefficient:",
                                    "ρs = 1 - (\"6 *  ∑\(d^{2}\) + \"m1^{3}-m1/12\" / \(n^{3}-n\)\")",
                                    "ρs = 1 - (\"6 * 7.5) + \"2^{3}-/12\" / \(6^{3}-6\)\")",
                                    "Final Result: ρs = 0.7714"
                                ]
                            },
                            {
                                question: "Fit a line y on x to the following data \n X: 0, 1, 2, 3, 4 \n Y: 1, 1.8, 3.3, 4.5, 6.3",
                                options: ["a = 0.47, b = 1.3", "a = 0.72, b = 1.33", "a = 0.73, b = 1.2", "a = 0.44, b = 1.22"],
                                correctAnswer: 1,
                                solutionSteps: [
                                    "Let n be the number of pairs; compute Sx, Sy, Sxy, Sx².",
                                    "Slope: b = (n·Sxy − Sx·Sy) / (n·Sx² − (Sx)²).",
                                    "Means: x̄ = Sx/n, ȳ = Sy/n.",
                                    "Intercept: a = ȳ − b·x̄.",
                                    "Compute values to get approximately a ≈ 0.72, b ≈ 1.33 (option B)."
                                ]
                            },
                            {
                                question: "A continuous random variable has probability density function: f(x) = k(x - x²), 0 ≤ x ≤ 1. Find (i) mean, (ii) variance.",
                                options: ["E(x) = 0.5 and Var(x) = 0.5", "E(x) = 0.05 and Var(x) = 0.3", "E(x) = 0.3 and Var(x) = 0.05", "E(x) = 0.5 and Var(x) = 0.05"],
                                correctAnswer: 3,
                                solutionSteps: [
                                    "Normalize: ∫₀¹ k(x − x²) dx = 1 ⇒ k·[x²/2 − x³/3]₀¹ = 1 ⇒ k·(1/6) = 1 ⇒ k = 6.",
                                    "E[x] = ∫₀¹ x·6(x − x²) dx = 6∫₀¹ (x² − x³) dx = 6(1/3 − 1/4) = 0.5.",
                                    "E[x²] = ∫₀¹ x²·6(x − x²) dx = 6∫₀¹ (x³ − x⁴) dx = 6(1/4 − 1/5) = 0.3.",
                                    "Var(x) = E[x²] − (E[x])² = 0.3 − 0.25 = 0.05.",
                                    "Thus E[x] = 0.5 and Var(x) = 0.05 (option D)."
                                ]
                            },
                            {
                                question: "Urn A contains 2 black and 1 white balls; urn B contains 1 black and 2 white balls; urn C contains 2 black and 2 white balls. One of the urns is selected at random and 1 ball is drawn. What is the probability of drawing a white ball from urn B?",
                                options: ["1/9", "1/3", "4/9", "2/9"],
                                correctAnswer: 2,
                                solutionSteps: [
                                    "P(selecting urn B) = 1/3 (each urn equally likely).",
                                    "P(white | urn B) = 2/3 (two white out of three).",
                                    "Overall probability = P(select B) × P(white | B); select the matching option."
                                ]
                            },
                            {
                                question: "Find the Fourier expansion of f(x) = x·cos(x), −π < x < π.",
                                options: [
                                    "(a₀) = 0, (aₙ) = 0, (bₙ) = -2πn/n²-1",
                                    "(a₀) = -2πn/n²-1, (aₙ) = 0, (bₙ) = 0)",
                                    "(a₀) = -4πn/n²-1, (aₙ) = 0, (bₙ) = -2πn/n²-1",
                                    "(a₀) = -2πn/n²-1, (aₙ) = -4πn/n²-1, (bₙ) = 0"
                                ],
                                correctAnswer: 0,
                                solutionSteps: [
                                    "Use Fourier series on (−π, π): compute a₀, aₙ, bₙ via standard integrals.",
                                    "a₀ = (1/π)∫_{−π}^{π} x·cos x dx (odd × even ⇒ integral = 0).",
                                    "Compute aₙ and bₙ by integration by parts; simplify using symmetry.",
                                    "Obtain bₙ terms of the form −2πn/(n² − 1); a₀ and aₙ vanish.",
                                    "Match the derived coefficients with the correct option."
                                ]
                            }
                        ]
                    };
                    // Persist enriched quiz (with questions and solution steps) to localStorage
                    try {
                        let quizzesLS = JSON.parse(localStorage.getItem('quizzes')) || [];
                        const idx = quizzesLS.findIndex(q => q.id === quizId);
                        if (idx >= 0) {
                            quizzesLS[idx] = { ...quizzesLS[idx], ...setAQuiz };
                            localStorage.setItem('quizzes', JSON.stringify(quizzesLS));
                        }
                    } catch (e) {
                        console.warn('Unable to persist Set A quiz with solutions to localStorage:', e);
                    }
                    
                    displayQuiz(setAQuiz);
                    return;
                }
                
                else if ((quiz.name && quiz.name === 'Data Structures Quiz - Set A') || (quiz.subject === 'Data Structures' && quiz.setPaper === 'Set A')) {
                    // Load questions from setA.py
                    const setAQuiz = {
                        id: quizId,
                        name: quiz.name || 'Data Structures Quiz - Set A',
                        duration: quiz.duration || 60,
                        branch: quiz.branch || 'COMPS',
                        semester: quiz.semester || 'Semester 3',
                        subject: quiz.subject || 'Data Structures',
                        numQuestions: 5,
                        setPaper: 'Set A',
                        questions: [
                            {
                                question: "What is stack ? what is algorithm of Push and pop ? Give example ?",
                                options: ["A stack is a linear data structure that follows the LIFO (Last In, First Out) principle. \n Push Algorithm: Add an element to the top of the stack.\n Pop Algorithm: Remove the top element from the stack.\n If we push 10, 20, 30 → the stack becomes [10, 20, 30].\nAfter one pop → the stack becomes [10, 20].",
                                          "A stack is a non-linear data structure that follows the FIFO (First In, First Out) principle.\n Push Algorithm: Add an element to the rear.\n Pop Algorithm: Remove an element from the front. \n Example: Queue of people waiting in line.",
                                          "A stack is a collection of elements arranged in ascending order.\n Push Algorithm: Insert element in sorted order. \nPop Algorithm: Remove the smallest element. Example: Sorted list of numbers [1, 2, 3, 4].",
                                          "A stack is a set of random elements where insertion and deletion can occur at any position.\n Push Algorithm: Insert at any random index.\n Pop Algorithm: Delete any element randomly.\n Example: Unordered array like [5, 2, 9]."
                                         ],
                                correctAnswer: 0,
                                solutionSteps: ["A stack is a linear data structure that follows the LIFO (Last In, First Out) principle — the last element inserted is the first one to be removed.",
                                            "Example: A stack of plates — you add (push) on top and remove (pop) from the top."]
                            },
                            {
                                question: "Convert the following infix expression to postfix form: (A+B/C∗D)/E−(F∗G)",
                                options: ["A B C D * / + E / F G * -", "A B C / D * + E / F G * -", "A B C / D * + E F G * / -", "A B + C D / * E / F G * -"],
                                correctAnswer: 1,
                                solutionSteps: ["Step-by-step conversion:",
                                            "1. Inside parentheses:",
                                            "B/C∗D → B C / D *",
                                            "So, A+(B/C*D) → A B C / D * +",
                                            "2. Divide by E:",
                                            "(A + B / C * D) / E → A B C / D * + E /",
                                            "3. Subtract (F * G):",
                                            "A B C / D * + E / F G * -"
                                        ]
                            },
                            {
                                question: "Check whether the following expression has well-formed parenthesis: {[]{()[{}]}}",
                                options: ["The parentheses are not well-formed — one or more closing brackets do not match their corresponding opening brackets.",
                                      "The parentheses are partially correct — only round brackets () are balanced, but {} or [] are not.",
                                      "The expression has a missing closing parenthesis",
                                      "The parentheses are well-formed — every opening bracket has a matching closing bracket in the correct order."
                                        ],
                                correctAnswer: 3,
                                solutionSteps: ["{ → push","[ → push","] → matches [ → pop","{ → push","( → push",") → matches ( → pop","[ → push","{ → push","} → matches { → pop","] → matches [ → pop","} → matches { → pop",
                                            "All brackets are properly opened and closed in correct order → Well-formed."
                                        ]
                            },
                            {
                                question: "Evaluate the postfix expression 8 2 3 * / 2 3 + * 5 +",
                                options: ["13", "12", "10", "15"],
                                correctAnswer: 2,
                                solutionSteps: ["Step-by-step evaluation:",
                                                "Step 1: Read 8 → push → [8]",
                                                "Step 2: Read 2 → push → [8, 2]",
                                                "Step 3: Read 3 → push → [8, 2, 3]",
                                                "Step 4: Read * → pop 3 and 2, compute 2 * 3 = 6, push 6 → [8, 6]",
                                                "Step 5: Read / → pop 6 and 8, compute 8/6 = 1, push 1 → [1]",
                                                "Step 6: Read 2 → push → [1, 2]",
                                                "Step 7: Read 3 → push → [1, 2, 3]",
                                                "Step 8: Read + → pop 3 and 2, compute 2 + 3 = 5, push 5 → [1, 5]",
                                                "Step 9: Read * → pop 5 and 1, compute 1 * 5= 5, push 5 → [5]",
                                                "Step 10: Read + → pop 5 and 5, compute 5 + 5 = 10, push 10 → [10]",
                                                "Final Result is 10."
                                                ]
                            },
                            {
                                question: "Which of the following statements correctly compares a Linked List and a Linear Array?",
                                options: ["In both linked lists and linear arrays, memory is allocated statically, and insertion/deletion operations are equally fast.",
                                          "In a linked list, memory is allocated dynamically, and insertion or deletion is easy. \n In a linear array, memory is allocated statically, and insertion or deletion is difficult.",
                                          "A linked list stores elements in contiguous memory, while a linear array stores elements in non-contiguous memory.",
                                          "A linear array allows unlimited elements, while a linked list has a fixed size once created."
                                        ],
                                correctAnswer: 1,
                                solutionSteps: ["In short: ",
                                            "Linked List → Flexible size, slower access.",
                                            "Array → Fixed size, faster access."]
                            }
                        ]
                    };
                    // Persist enriched quiz (with questions and solution steps) to localStorage
                    try {
                        let quizzesLS = JSON.parse(localStorage.getItem('quizzes')) || [];
                        const idx = quizzesLS.findIndex(q => q.id === quizId);
                        if (idx >= 0) {
                            quizzesLS[idx] = { ...quizzesLS[idx], ...setAQuiz };
                            localStorage.setItem('quizzes', JSON.stringify(quizzesLS));
                        }
                    } catch (e) {
                        console.warn('Unable to persist Set A quiz with solutions to localStorage:', e);
                    }
                    
                    displayQuiz(setAQuiz);
                    return;
                }


                // Hide the quizzes content and show the active quiz content
                const quizzesContent = document.getElementById('quizzes-content');
                const quizActiveContent = document.getElementById('quiz-active-content');
                
                if (quizzesContent) quizzesContent.classList.add('hidden');
                if (quizActiveContent) quizActiveContent.classList.remove('hidden');
                
                // Update the URL hash to reflect the active quiz
                window.location.hash = '#quiz-active';
                
                // Display quiz information
                const questionsContainer = document.getElementById('quiz-questions-container');
                
                // Set up the timer
                let timeLeft = quiz.duration * 60; // Convert minutes to seconds
                
                // Update timer display immediately
                updateTimerDisplay(timeLeft);
                
                // Start the timer
                const timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timeLeft);
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert('Time is up! The quiz will be automatically submitted.');
                        submitQuiz(quizId);
                    }
                }, 1000);
                
                // Store timer interval ID so we can clear it later if needed
                window.quizTimerInterval = timerInterval;
                
                // Generate questions based on quiz configuration
                if (quiz.questions && quiz.questions.length > 0) {
                    // Use existing questions from the quiz object
                    generateQuizQuestions(quiz, questionsContainer);
                } else {
                    // Fallback: generate questions if none exist (for legacy quizzes)
                    const fallbackQuiz = generateFallbackQuestions(quiz);
                    generateQuizQuestions(fallbackQuiz, questionsContainer);
                }
                
                // Set up submit button
                const submitBtn = document.getElementById('submit-quiz-btn');
                if (submitBtn) {
                    submitBtn.onclick = () => {
                        clearInterval(timerInterval);
                        submitQuiz(quizId);
                    };
                }
                
                // Set up back button
                const backBtn = document.getElementById('back-to-quizzes-btn');
                if (backBtn) {
                    backBtn.onclick = () => {
                        if (confirm('Are you sure you want to leave this quiz? Your progress will be lost.')) {
                            clearInterval(timerInterval);
                            if (quizActiveContent) quizActiveContent.classList.add('hidden');
                            
                            // Get current user to determine where to navigate back to
                            const currentUser = getCurrentUser();
                            const isTeacher = currentUser && currentUser.role === 'teacher';
                            
                            if (isTeacher) {
                                // Teachers go back to Quiz Management
                                if (quizzesContent) quizzesContent.classList.remove('hidden');
                                window.location.hash = '#quizzes';
                            } else {
                                // Students go back to Available Quizzes
                                const studentQuizzesContent = document.getElementById('student-quizzes-content');
                                if (studentQuizzesContent) studentQuizzesContent.classList.remove('hidden');
                                window.location.hash = '#student-quizzes';
                            }
                        }
                    };
                }
            }
            
            
            
            function getQuizResults(userId = null) {
                const quizResults = JSON.parse(localStorage.getItem('quizResults')) || [];
                
                if (userId) {
                    return quizResults.filter(result => result.userId === userId);
                }
                
                return quizResults;
            }
            
            function getQuizResultsForQuiz(quizId, userId = null) {
                const results = getQuizResults(userId);
                return results.filter(result => result.quizId === quizId);
            }
            
            function getCurrentUser() {
                const currentUser = localStorage.getItem('currentUser');
                return currentUser ? JSON.parse(currentUser) : null;
            }

            function saveQuizResult(quizId, score, totalQuestions, answers) {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.error('No user logged in - cannot save quiz result');
                    return null;
                }
                const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
                const marksPerQuestion = 4;
                const result = {
                    id: 'result_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8),
                    quizId,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    score,
                    totalQuestions,
                    percentage,
                    marks: score * marksPerQuestion,
                    totalMarks: totalQuestions * marksPerQuestion,
                    answers,
                    completedAt: new Date().toISOString()
                };
                const allResults = JSON.parse(localStorage.getItem('quizResults')) || [];
                allResults.push(result);
                localStorage.setItem('quizResults', JSON.stringify(allResults));

                (async () => {
                    try {
                        const token = localStorage.getItem('authToken');
                        const payload = {
                            score,
                            totalQuestions,
                            percentage,
                            marks: result.marks,
                            totalMarks: result.totalMarks,
                            answers,
                            userName: currentUser.name,
                            branch: currentUser.branch,
                            semester: currentUser.semester
                        };
                        const res = await fetch(`/api/quizzes/${quizId}/results`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            const data = await res.json().catch(() => ({}));
                            console.warn('Failed to persist quiz result:', res.status, data?.error || res.statusText);
                        }
                    } catch (e) {
                        console.warn('Error sending quiz result to server:', e);
                    }
                })();
                return result;
            }

            function updateDashboardQuizCount() {
                (async () => {
                    try {
                        const user = getCurrentUser();
                        const role = user?.role || '';
                        const branch = user?.branch || '';
                        const quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                        let count;
                        if (role === 'student') {
                            const computed = branch ? quizzes.filter(q => q.branch === branch).length : quizzes.length;
                            count = computed;
                            localStorage.setItem('dashboardQuizCount', String(count));
                        } else {
                            const storedRaw = localStorage.getItem('dashboardQuizCount');
                            if (storedRaw != null && storedRaw !== '') {
                                const parsed = parseInt(storedRaw, 10);
                                count = Number.isNaN(parsed) ? 0 : parsed;
                            } else {
                                const computed = quizzes.length;
                                count = computed;
                                localStorage.setItem('dashboardQuizCount', String(count));
                            }
                        }
                        const el = document.getElementById('dashboard-quiz-count');
                        if (el) el.textContent = String(count);
                    } catch (e) {
                        console.error('Failed to update dashboard quiz count:', e);
                    }
                })();
            }
            
            function submitQuiz(quizId) {
                // Get the quiz data from localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                const quiz = quizzes.find(q => q.id === quizId);
                
                if (!quiz) {
                    alert('Quiz not found!');
                    return;
                }
                
                // Helper: normalize correct answer to option index (0-3)
                function getCorrectIndex(question) {
                    const ca = question.correctAnswer;
                    if (typeof ca === 'number') return ca;
                    if (typeof ca === 'string') {
                        const s = ca.trim();
                        if (/^\d+$/.test(s)) return parseInt(s, 10);
                        const map = { A: 0, B: 1, C: 2, D: 3 };
                        const upper = s.toUpperCase();
                        if (upper in map) return map[upper];
                        // Fallback: treat string as option text and match
                        const idx = Array.isArray(question.options)
                          ? question.options.findIndex(opt => String(opt).trim() === s)
                          : -1;
                        return idx;
                    }
                    return -1;
                }

                // Calculate score and collect answers
                let score = 0;
                const answers = [];
                // For Set A quiz, we need to check if questions exist in the quiz object
                const questions = quiz.questions || [];
                questions.forEach((question, index) => {
                    const userAnswer = document.querySelector(`input[name="question-${index}"]:checked`);
                    const userIndex = userAnswer ? parseInt(userAnswer.value, 10) : null;
                    const correctIndex = getCorrectIndex(question);
                    const isCorrect = userIndex !== null && correctIndex !== -1 && userIndex === correctIndex;
                    
                    if (isCorrect) {
                        score++;
                    }
                    
                    answers.push({
                        questionIndex: index,
                        question: question.question,
                        userAnswer: userIndex !== null ? String(userIndex) : null,
                        correctAnswer: correctIndex !== -1 ? String(correctIndex) : null,
                        userOptionText: (userIndex !== null && Array.isArray(question.options) && question.options[userIndex] !== undefined) ? String(question.options[userIndex]) : (userIndex === null ? 'Not answered' : null),
                        correctOptionText: (correctIndex !== -1 && Array.isArray(question.options) && question.options[correctIndex] !== undefined) ? String(question.options[correctIndex]) : null,
                        isCorrect: isCorrect,
                        solutionSteps: Array.isArray(question.solutionSteps) ? question.solutionSteps : undefined
                    });
                });
                
                // Save quiz result
                const result = saveQuizResult(quizId, score, questions.length, answers);

                // Refresh student quiz history immediately
                try {
                    if (typeof displayStudentQuizResults === 'function') {
                        displayStudentQuizResults();
                    }
                } catch (e) {
                    console.warn('Unable to refresh student quiz results after submission:', e);
                }
                
                // Display marks
                const scoreDisplay = document.getElementById('quiz-score');
                if (scoreDisplay) {
                    const totalQ = questions.length || quiz.numQuestions;
                    const totalMarks = (result && result.totalMarks) ? result.totalMarks : totalQ * 4;
                    const marks = (result && result.marks) ? result.marks : score * 4;
                    scoreDisplay.textContent = `You scored ${marks} out of ${totalMarks} marks (${score}/${totalQ} correct)`;
                }
                
                // Hide the quiz questions and show the score
                const questionsContainer = document.getElementById('quiz-questions-container');
                const scoreContainer = document.getElementById('quiz-score-container');
                
                if (questionsContainer) questionsContainer.classList.add('hidden');
                if (scoreContainer) scoreContainer.classList.remove('hidden');
                
                // Set up retry button
                const retryBtn = document.getElementById('retry-quiz-btn');
                if (retryBtn) {
                    retryBtn.onclick = () => {
                        if (scoreContainer) scoreContainer.classList.add('hidden');
                        if (questionsContainer) questionsContainer.classList.remove('hidden');
                        startQuiz(quizId);
                    };
                }
            }
            
            function updateTimerDisplay(seconds) {
                const total = Math.max(0, Math.floor(seconds));
                const minutes = Math.floor(total / 60);
                const secs = total % 60;
                const el = document.getElementById('quiz-timer');
                if (el) {
                    el.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }
            }
            
            function displayQuiz(quiz) {
                // Hide the quizzes content and show the active quiz content
                const quizzesContent = document.getElementById('quizzes-content');
                const quizActiveContent = document.getElementById('quiz-active-content');
                
                if (quizzesContent) quizzesContent.classList.add('hidden');
                if (quizActiveContent) quizActiveContent.classList.remove('hidden');
                
                // Update the URL hash to reflect the active quiz
                window.location.hash = '#quiz-active';
                
                // Display quiz information
                const questionsContainer = document.getElementById('quiz-questions-container');

                // Populate active quiz meta header
                const activeQuizNameEl = document.getElementById('active-quiz-name');
                const activeQuizBranchEl = document.getElementById('active-quiz-branch');
                const activeQuizSemesterEl = document.getElementById('active-quiz-semester');
                const activeQuizSubjectEl = document.getElementById('active-quiz-subject');

                if (activeQuizNameEl) activeQuizNameEl.textContent = quiz.name || 'Untitled Quiz';
                if (activeQuizBranchEl) activeQuizBranchEl.textContent = `Branch: ${quiz.branch || 'N/A'}`;
                if (activeQuizSemesterEl) activeQuizSemesterEl.textContent = `Semester: ${quiz.semester || 'N/A'}`;
                if (activeQuizSubjectEl) activeQuizSubjectEl.textContent = `Subject: ${quiz.subject || 'N/A'}`;
                
                // Set up the timer
                let timeLeft = quiz.duration * 60; // Convert minutes to seconds
                
                // Update timer display immediately
                updateTimerDisplay(timeLeft);
                
                // Start the timer
                const timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timeLeft);
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert('Time is up! The quiz will be automatically submitted.');
                        submitQuiz(quiz.id);
                    }
                }, 1000);
                
                // Store timer interval ID so we can clear it later if needed
                window.quizTimerInterval = timerInterval;
                
                // Generate questions for the quiz
                generateQuizQuestions(quiz, questionsContainer);
                
                // Set up submit button
                const submitBtn = document.getElementById('submit-quiz-btn');
                if (submitBtn) {
                    submitBtn.onclick = () => {
                        clearInterval(timerInterval);
                        submitQuiz(quiz.id);
                    };
                }
                
                // Set up back button
                const backBtn = document.getElementById('back-to-quizzes-btn');
                if (backBtn) {
                    backBtn.onclick = () => {
                        if (confirm('Are you sure you want to leave this quiz? Your progress will be lost.')) {
                            clearInterval(timerInterval);
                            if (quizActiveContent) quizActiveContent.classList.add('hidden');
                            
                            // Get current user to determine where to navigate back to
                            const currentUser = getCurrentUser();
                            const isTeacher = currentUser && currentUser.role === 'teacher';
                            
                            if (isTeacher) {
                                // Teachers go back to Quiz Management
                                if (quizzesContent) quizzesContent.classList.remove('hidden');
                                window.location.hash = '#quizzes';
                            } else {
                                // Students go back to Available Quizzes
                                const studentQuizzesContent = document.getElementById('student-quizzes-content');
                                if (studentQuizzesContent) studentQuizzesContent.classList.remove('hidden');
                                window.location.hash = '#student-quizzes';
                                // Reload available quizzes and refresh history
                                try {
                                    if (typeof loadStudentQuizzes === 'function') {
                                        loadStudentQuizzes();
                                    } else if (typeof displayStudentQuizResults === 'function') {
                                        displayStudentQuizResults();
                                    }
                                } catch (e) {
                                    console.warn('Unable to refresh student quizzes/history when returning:', e);
                                }
                            }
                        }
                    };
                }
            }
            
            function init() {
                const quizFilterBranch = document.getElementById('quiz-filter-branch');
                const quizFilterSemester = document.getElementById('quiz-filter-semester');
                const quizFilterSubject = document.getElementById('quiz-filter-subject');
                
                if (quizFilterBranch) {
                    quizFilterBranch.addEventListener('change', loadQuizzes);
                }
                if (quizFilterSemester) {
                    quizFilterSemester.addEventListener('change', loadQuizzes);
                }
                if (quizFilterSubject) {
                    quizFilterSubject.addEventListener('change', loadQuizzes);
                }
                
                // Load quizzes on initialization
                loadQuizzes();
            }
            
            function loadQuizzes() {
                const quizzesList = document.getElementById('quizzes-list');
                if (!quizzesList) return;
                
                // Get filter values
                const filterBranch = document.getElementById('quiz-filter-branch')?.value || '';
                const filterSemester = document.getElementById('quiz-filter-semester')?.value || '';
                const filterSubject = document.getElementById('quiz-filter-subject')?.value || '';
                
                // Get quizzes from localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                
                // Apply filters
                quizzes = quizzes.filter(quiz => {
                    const matchesBranch = !filterBranch || quiz.branch === filterBranch;
                    const matchesSemester = !filterSemester || quiz.semester === filterSemester;
                    const matchesSubject = !filterSubject || quiz.subject === filterSubject;
                    return matchesBranch && matchesSemester && matchesSubject;
                });
                
                // Display quizzes
                if (quizzes.length === 0) {
                    quizzesList.innerHTML = `
                        <div class="text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-slate-400"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                            <h3 class="mt-2 text-lg font-semibold text-slate-800">No quizzes found</h3>
                            <p class="mt-1 text-sm text-slate-500">Try adjusting your filter criteria or create your first quiz using the form above.</p>
                        </div>
                    `;
                } else {
                    quizzesList.innerHTML = quizzes.map(quiz => `
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-slate-800">${quiz.name}</h3>
                                    <div class="flex flex-wrap items-center gap-2 mt-2">
                                        <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-md">${quiz.subject}</span>
                                        <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-md">${quiz.semester}</span>
                                        <span class="text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded-md">${quiz.branch}</span>
                                        <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded-md">${quiz.numQuestions} questions</span>
                                        <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded-md">${quiz.duration} min</span>
                                        ${quiz.setPaper ? `<span class="text-xs font-medium text-orange-700 bg-orange-100 px-2 py-1 rounded-md">${quiz.setPaper}</span>` : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-2">Created: ${new Date(quiz.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="start-quiz-btn bg-green-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-green-700 transition-colors" data-quiz-id="${quiz.id}">
                                        Start Quiz
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            function generateQuizQuestions(quiz, container) {
                container.innerHTML = quiz.questions.map((question, index) => {
                    // Format question number and text
                    const questionNumber = index + 1;
                    const formattedQuestion = question.question
                        .replace(/\n/g, '<br>') // Convert newlines to HTML line breaks
                        .replace(/X:/g, '<strong>X:</strong>') // Bold X label
                        .replace(/Y:/g, '<strong>Y:</strong>') // Bold Y label
                        .replace(/\(frac/g, '(<span class="math-fraction">frac') // Style fractions
                        .replace(/\)/g, ')</span>');
                    
                    return `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <div class="flex items-start mb-4">
                                <span class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-800 font-bold mr-3">
                                    ${questionNumber}
                                </span>
                                <h3 class="font-bold text-lg text-slate-800">${formattedQuestion}</h3>
                            </div>
                            <div class="ml-11 space-y-3">
                                ${question.options.map((option, optionIndex) => {
                                    // Format option text
                                    const formattedOption = option
                                        .replace(/\n/g, '<br>')
                                        .replace(/\^/g, '<sup>')
                                        .replace(/\</g, '&lt;')
                                        .replace(/\>/g, '&gt;');
                                    
                                    return `
                                        <label class="flex items-start space-x-3 p-3 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
                                            <input type="radio" name="question-${index}" value="${optionIndex}" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                            <span class="text-slate-700">
                                                <span class="font-medium mr-2">${String.fromCharCode(65 + optionIndex)}.</span>
                                                ${formattedOption}
                                            </span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add custom styles for math formatting
                const style = document.createElement('style');
                style.textContent = `
                    .math-fraction {
                        font-style: italic;
                    }
                `;
                document.head.appendChild(style);
            }
            
            function generateFallbackQuestions(quiz) {
                const count = Number(quiz.numQuestions) || 5;
                const questions = Array.from({ length: count }, (_, i) => ({
                    question: `Question ${i + 1}`,
                    options: [
                        'Option A',
                        'Option B',
                        'Option C',
                        'Option D'
                    ],
                    correctAnswer: 0
                }));
                return { ...quiz, questions };
            }


            

            
            // Initialize quiz management when the quizzes section is loaded
            window.addEventListener('hashchange', function() {
                if (window.location.hash === '#quizzes') {
                    setTimeout(initQuizManagement, 100);
                }
            });
            
            async function createQuiz() {
                // Disable the create button to prevent double submission
                const createButton = document.getElementById('create-quiz-btn');
                if (createButton) {
                    createButton.disabled = true;
                    createButton.textContent = 'Creating...';
                }
                
                const quizName = document.getElementById('quiz-name').value;
                const quizDuration = document.getElementById('quiz-duration').value;
                const quizBranch = document.getElementById('quiz-branch').value;
                const quizSemester = document.getElementById('quiz-semester').value;
                const quizSubject = document.getElementById('quiz-subject').value;
                const quizNumQuestions = document.getElementById('quiz-num-questions').value;
                const quizSetPaper = document.getElementById('quiz-set-paper').value;
                
                // Validate required fields
                if (!quizName || !quizDuration || !quizBranch || !quizSemester || !quizSubject || !quizNumQuestions) {
                    showToast('Please fill in all required fields!', 'error');
                    if (createButton) {
                        createButton.disabled = false;
                        createButton.textContent = 'Create Quiz';
                    }
                    return;
                }
                
                // Create quiz object with more unique ID
                const quiz = {
                    id: 'quiz_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: quizName,
                    duration: quizDuration,
                    branch: quizBranch,
                    semester: quizSemester,
                    subject: quizSubject,
                    numQuestions: quizNumQuestions,
                    setPaper: quizSetPaper,
                    createdAt: new Date().toISOString(),
                    createdBy: getCurrentUser().id || 'unknown',
                    questions: [] // Initialize empty questions array
                };
                
                // Special handling for Maths Quiz - Set A
                if (quizBranch === 'COMPS' && quizSemester === 'Semester 3' && quizSubject === 'MATHS' && quizSetPaper === 'Set A') {
                    quiz.name = 'Maths Quiz - Set A';
                    // Add the predefined questions for Set A
                    quiz.questions = [
                        {
                            question: "Compute Spearman's rank correlation coefficient from the following data:\nX: 40,42,45,35,36,39 \nY: 46,43,44,39,40,43",
                            options: ["0.7714", "0.7614", "0", "0.78"],
                            correctAnswer: 0
                        },
                        {
                            question: "Fit a line y on x to the following data \n X: 0,1,2,3,4 \n Y: 1,1.8,3.3,4.5,6.3",
                            options: ["a = 0.47, b = 1.3", "a = 0.72, b = 1.33", "a = 0.73, b = 1.2", "a = 0.44, b = 1.22"],
                            correctAnswer: 1
                        },
                        {
                            question: "A continuous random variable has probability density function: f(x)=k(x- x^2), 0≤x≤1. Find (i) mean, (ii) variance.",
                            options: ["E(x)=0.5 and Var(x)=0.5", "E(x)=0.05 and Var(x)=0.3", "E(x)=0.3 and Var(x)=0.05", "E(x)=0.5 and Var(x)=0.05"],
                            correctAnswer: 3
                        },
                        {
                            question: "Earn A contains 2 black and 1 white balls; earn B contains 1 black and 2 white balls; earn C contains 2 black and 2 white balls. One of the urns is selected at random and 1 ball is drawn. What is the probability of drawing a white ball from earn B?",
                            options: ["1/9", "1/3", "4/9", "2/9"],
                            correctAnswer: 2
                        },
                        {
                            question: "Find the Fourier expansion of f(x)=xcosx, −π<x<π.",
                            options: ["(a_{0})=0, (a_{n})=0, (b_{n})=(frac{-2π n}{n^{2}-1})", "(a_{0})=(frac{-2π n}{n^{2}-1}), (a_{n})=0, (b_{n})=0", "(a_{0})=(frac{-4π n}{n^{2}-1}), (a_{n})=0, (b_{n})=(frac{-2π n}{n^{2}-1})", "(a_{0})=(frac{-2 π n}{n^{2}-1}), (a_{n})=(frac{-4 π n}{n^{2}-1}), (b_{n})=0"],
                            correctAnswer: 0
                        }
                    ];
                }
                
                else if (quizBranch === 'COMPS' && quizSemester === 'Semester 3' && quizSubject === 'Data Structures' && quizSetPaper === 'Set A') {
                    quiz.name = 'Data Structures Quiz - Set A';
                    // Add the predefined questions for Set A
                    quiz.questions = [
                        {
                            question: "What is stack ? what is algorithm of Push and pop ? Give example ?",
                            options: ["A stack is a linear data structure that follows the LIFO (Last In, First Out) principle. \n Push Algorithm: Add an element to the top of the stack.\n Pop Algorithm: Remove the top element from the stack.\n If we push 10, 20, 30 → the stack becomes [10, 20, 30].\nAfter one pop → the stack becomes [10, 20].",
                                      "A stack is a non-linear data structure that follows the FIFO (First In, First Out) principle.\n Push Algorithm: Add an element to the rear.\n Pop Algorithm: Remove an element from the front. \n Example: Queue of people waiting in line.",
                                      "A stack is a collection of elements arranged in ascending order.\n Push Algorithm: Insert element in sorted order. \nPop Algorithm: Remove the smallest element. Example: Sorted list of numbers [1, 2, 3, 4].",
                                      "A stack is a set of random elements where insertion and deletion can occur at any position.\n Push Algorithm: Insert at any random index.\n Pop Algorithm: Delete any element randomly.\n Example: Unordered array like [5, 2, 9]."
                            ],
                            correctAnswer: 0,
                            solutionSteps: ["A stack is a linear data structure that follows the LIFO (Last In, First Out) principle — the last element inserted is the first one to be removed.",
                                            "Example: A stack of plates — you add (push) on top and remove (pop) from the top."]
                        },
                        {
                            question: "Convert the following infix expression to postfix form: (A+B/C∗D)/E−(F∗G)",
                            options: ["A B C D * / + E / F G * -", "A B C / D * + E / F G * -", "A B C / D * + E F G * / -", "A B + C D / * E / F G * -"],
                            correctAnswer: 1,
                            solutionSteps: ["Step-by-step conversion:",
                                            "1. Inside parentheses:",
                                            "B/C∗D → B C / D *",
                                            "So, A+(B/C*D) → A B C / D * +",
                                            "2. Divide by E:",
                                            "(A + B / C * D) / E → A B C / D * + E /",
                                            "3. Subtract (F * G):",
                                            "A B C / D * + E / F G * -"
                            ]
                        },
                        {
                            question: "Evaluate the postfix expression 8 2 3 * / 2 3 + * 5 +",
                            options: ["13", "12", "10", "15"],
                            correctAnswer: 2,
                            solutionSteps: ["Step-by-step evaluation:",
                                            "Step 1: Read 8 → push → [8]",
                                            "Step 2: Read 2 → push → [8, 2]",
                                            "Step 3: Read 3 → push → [8, 2, 3]",
                                            "Step 4: Read * → pop 3 and 2, compute 2 * 3 = 6, push 6 → [8, 6]",
                                            "Step 5: Read / → pop 6 and 8, compute 8/6 = 1, push 1 → [1]",
                                            "Step 6: Read 2 → push → [1, 2]",
                                            "Step 7: Read 3 → push → [1, 2, 3]",
                                            "Step 8: Read + → pop 3 and 2, compute 2 + 3 = 5, push 5 → [1, 5]",
                                            "Step 9: Read * → pop 5 and 1, compute 1 * 5= 5, push 5 → [5]",
                                            "Step 10: Read + → pop 5 and 5, compute 5 + 5 = 10, push 10 → [10]",
                                            "Final Result is 10."
                            ]
                        },
                        {
                            question: "Check whether the following expression has well-formed parenthesis: {[]{()[{}]}}",
                            options: ["The parentheses are not well-formed — one or more closing brackets do not match their corresponding opening brackets.",
                                      "The parentheses are partially correct — only round brackets () are balanced, but {} or [] are not.",
                                      "The expression is invalid because it contains nested brackets of different types.",
                                      "The parentheses are well-formed — every opening bracket has a matching closing bracket in the correct order."
                            ],       
                            correctAnswer: 3,
                            solutionSteps: ["{ → push","[ → push","] → matches [ → pop","{ → push","( → push",") → matches ( → pop","[ → push","{ → push","} → matches { → pop","] → matches [ → pop","} → matches { → pop",
                                            "All brackets are properly opened and closed in correct order → Well-formed."
                            ]
                        },
                        {
                            question: "Which of the following statements correctly compares a Linked List and a Linear Array?",
                            options: ["In a linked list, memory is allocated dynamically, and insertion or deletion is easy. \n In a linear array, memory is allocated statically, and insertion or deletion is difficult.",
                                     "In both linked lists and linear arrays, memory is allocated statically, and insertion/deletion operations are equally fast.",
                                      "A linked list stores elements in contiguous memory, while a linear array stores elements in non-contiguous memory.",
                                      "A linear array allows unlimited elements, while a linked list has a fixed size once created."
                            ],
                            correctAnswer: 0,
                            solutionSteps: ["In short: ",
                                            "Linked List → Flexible size, slower access.",
                                            "Array → Fixed size, faster access."]
                        }
                    ];
                }
                
                try {
                    const { apiRequest } = await import('./assets/js/api.js');
                    const payload = {
                        name: quiz.name,
                        duration: Number(quiz.duration),
                        branch: quiz.branch,
                        semester: quiz.semester,
                        subject: quiz.subject,
                        numQuestions: Number(quiz.numQuestions),
                        setPaper: quiz.setPaper,
                        questions: (quiz.questions || []).map(q => ({
                            question: q.question,
                            options: q.options,
                            correct: typeof q.correct === 'number' ? q.correct : (typeof q.correctAnswer === 'number' ? q.correctAnswer : 0)
                        }))
                    };
                    const res = await apiRequest('/quizzes', { method: 'POST', body: JSON.stringify(payload) });
                    if (res && res.quiz && res.quiz._id) {
                        quiz.id = res.quiz._id;
                    }
                } catch (_) {}

                
                // Save to localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                quizzes.push(quiz);
                localStorage.setItem('quizzes', JSON.stringify(quizzes));
                try {
                    const user = getCurrentUser();
                    const role = user?.role || '';
                    let count;
                    if (role === 'teacher') {
                        count = quizzes.length;
                    } else {
                        const branch = user?.branch || '';
                        count = branch ? quizzes.filter(q => q.branch === branch).length : quizzes.length;
                    }
                    const el = document.getElementById('dashboard-quiz-count');
                    if (el) el.textContent = String(count);
                    localStorage.setItem('dashboardQuizCount', String(count));
                } catch (_) {}
                updateDashboardQuizCount();
                
                showToast('Quiz created successfully!');
                
                // Reset form
                document.getElementById('create-quiz-form').reset();
                
                // Re-enable the create button
                if (createButton) {
                    createButton.disabled = false;
                    createButton.textContent = 'Create Quiz';
                }
                
                // Refresh the quizzes list
                loadQuizzes();
                
                // Also refresh student quizzes if the student dashboard is active
                if (document.getElementById('student-quizzes-content')?.style.display !== 'none') {
                    loadStudentQuizzes();
                }
            }
            
            function viewQuizzes() {
                // Get filter values
                const filterBranch = document.getElementById('view-quiz-branch')?.value || '';
                const filterSemester = document.getElementById('view-quiz-semester')?.value || '';
                const filterSubject = document.getElementById('view-quiz-subject')?.value || '';
                
                // Get quizzes from localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                
                // Apply filters
                quizzes = quizzes.filter(quiz => {
                    const matchesBranch = !filterBranch || quiz.branch === filterBranch;
                    const matchesSemester = !filterSemester || quiz.semester === filterSemester;
                    const matchesSubject = !filterSubject || quiz.subject === filterSubject;
                    return matchesBranch && matchesSemester && matchesSubject;
                });
                
                // Display results
                const resultsContainer = document.getElementById('view-quiz-results');
                if (!resultsContainer) return;
                
                if (quizzes.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-6">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-10 w-10 text-slate-400"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <h3 class="mt-2 text-base font-semibold text-slate-800">No quizzes found</h3>
                            <p class="mt-1 text-sm text-slate-500">Try adjusting your filter criteria.</p>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = quizzes.map(quiz => `
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-slate-800">${quiz.name}</h4>
                                    <div class="flex flex-wrap items-center gap-2 mt-2">
                                        <span class="text-xs font-medium text-slate-600 bg-white px-2 py-1 rounded border">${quiz.subject}</span>
                                        <span class="text-xs font-medium text-slate-600 bg-white px-2 py-1 rounded border">${quiz.semester}</span>
                                        <span class="text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded border">${quiz.branch}</span>
                                        <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded border">${quiz.numQuestions} questions</span>
                                        <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded border">${quiz.duration} min</span>
                                        ${quiz.setPaper ? `<span class="text-xs font-medium text-orange-700 bg-orange-100 px-2 py-1 rounded border">${quiz.setPaper}</span>` : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-2">Created: ${new Date(quiz.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button class="start-quiz-btn bg-green-600 text-white text-xs font-semibold px-3 py-1.5 rounded hover:bg-green-700 transition-colors" data-quiz-id="${quiz.id}">
                                        Start
                                    </button>
                                    <button class="delete-quiz-btn bg-red-600 text-white text-xs font-semibold px-3 py-1.5 rounded hover:bg-red-700 transition-colors" data-quiz-id="${quiz.id}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners to the buttons
                    setTimeout(() => {
                        // Add event listeners to start quiz buttons
                        const startButtons = resultsContainer.querySelectorAll('.start-quiz-btn');
                        startButtons.forEach(button => {
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                            newButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                const quizId = this.getAttribute('data-quiz-id');
                                startQuiz(quizId);
                            });
                        });
                        
                        // Add event listeners to delete quiz buttons
                        const deleteButtons = resultsContainer.querySelectorAll('.delete-quiz-btn');
                        deleteButtons.forEach(button => {
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                            newButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                const quizId = this.getAttribute('data-quiz-id');
                                deleteQuiz(quizId);
                            });
                        });
                    }, 100);
                    
                    // Add "Clear All Quizzes" button if there are quizzes
                    if (quizzes.length > 0) {
                        const clearAllButton = document.createElement('button');
                        clearAllButton.id = 'clear-all-quizzes-btn';
                        clearAllButton.className = 'mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors font-medium';
                        clearAllButton.textContent = 'Clear All Quizzes';
                        clearAllButton.onclick = clearAllQuizzes;
                        resultsContainer.appendChild(clearAllButton);
                    }
                }
            }
            
            // Initialize sample quizzes once if storage is empty (first run only)
            function initSampleQuizzes() {
                console.log('Initializing sample quizzes (one-time)...');
                let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                
                console.log('Existing quizzes count at init:', quizzes.length);
                
                // Only seed on first run when there are NO quizzes at all
                if (quizzes.length === 0) {
                    const setAQuiz = {
                        id: 'sample-set-a-' + Date.now(),
                        name: 'Maths Quiz - Set A',
                        duration: 30,
                        branch: 'COMPS',
                        semester: 'Semester 3',
                        subject: 'MATHS',
                        numQuestions: 5,
                        setPaper: 'Set A',
                        createdAt: new Date().toISOString(),
                        createdBy: 'system'
                    };
                    quizzes.push(setAQuiz);
                    localStorage.setItem('quizzes', JSON.stringify(quizzes));
                    updateDashboardQuizCount();
                    console.log('Seeded sample Set A quiz. Total now:', quizzes.length);
                } else {
                    console.log('Skipping seeding; quizzes already exist.');
                }
                
                // Mark seeding as done to avoid re-adding on future refreshes
                localStorage.setItem('sampleQuizzesInitialized', 'true');
            }
            
            // Initialize on first load if already on quizzes page
            if (window.location.hash === '#quizzes') {
                setTimeout(initQuizManagement, 100);
            }

            // Keep dashboard quiz count in sync on load and navigation changes
            document.addEventListener('DOMContentLoaded', updateDashboardQuizCount);
            window.addEventListener('hashchange', updateDashboardQuizCount);
            
            // Delete quiz function
            function deleteQuiz(quizId) {
                if (confirm('Are you sure you want to delete this quiz? This action cannot be undone.')) {
                    (async () => {
                        try {
                            const { apiRequest } = await import('./assets/js/api.js');
                            await apiRequest(`/quizzes/${quizId}`, { method: 'DELETE' });
                        } catch (_) {}

                        let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                        quizzes = quizzes.filter(quiz => quiz.id !== quizId);
                        localStorage.setItem('quizzes', JSON.stringify(quizzes));
                        try {
                            const user = getCurrentUser();
                            const role = user?.role || '';
                            let count;
                            if (role === 'teacher') {
                                count = quizzes.length;
                            } else {
                                const branch = user?.branch || '';
                                count = branch ? quizzes.filter(q => q.branch === branch).length : quizzes.length;
                            }
                            const el = document.getElementById('dashboard-quiz-count');
                            if (el) el.textContent = String(count);
                            localStorage.setItem('dashboardQuizCount', String(count));
                        } catch (_) {}
                        updateDashboardQuizCount();
                        showToast('Quiz deleted successfully!');
                        loadQuizzes();
                        viewQuizzes();
                        if (document.getElementById('student-quizzes-content')?.style.display !== 'none') {
                            loadStudentQuizzes();
                        }
                    })();
                }
            }
            
            // Clear all quizzes function
            function clearAllQuizzes() {
                if (confirm('Are you sure you want to delete ALL quizzes? This action cannot be undone.')) {
                    (async () => {
                        try {
                            const { apiRequest } = await import('./assets/js/api.js');
                            await apiRequest('/quizzes', { method: 'DELETE' });
                        } catch (_) {}

                        localStorage.removeItem('quizzes');
                        try {
                            const el = document.getElementById('dashboard-quiz-count');
                            if (el) el.textContent = '0';
                            localStorage.setItem('dashboardQuizCount', '0');
                        } catch (_) {}
                        updateDashboardQuizCount();
                        showToast('All quizzes cleared successfully!');
                        loadQuizzes();
                        viewQuizzes();
                        if (document.getElementById('student-quizzes-content')?.style.display !== 'none') {
                            loadStudentQuizzes();
                        }
                    })();
                }
            }
            
            // Student Quizzes Functionality
            function initStudentQuizzes() {
                console.log('Initializing student quizzes');
                
                // Load student quizzes on initialization
                loadStudentQuizzes();
                
                // Add event listeners to filter controls
                const loadButton = document.getElementById('load-student-quizzes-btn');
                const branchFilter = document.getElementById('student-quiz-branch');
                const semesterFilter = document.getElementById('student-quiz-semester');
                const subjectFilter = document.getElementById('student-quiz-subject');
                const clearHistoryBtn = document.getElementById('clear-student-quiz-history-btn');
                
                if (loadButton) {
                    loadButton.addEventListener('click', loadStudentQuizzes);
                }
                
                if (branchFilter) {
                    branchFilter.addEventListener('change', loadStudentQuizzes);
                }
                
                if (semesterFilter) {
                    semesterFilter.addEventListener('change', loadStudentQuizzes);
                }
                
                if (subjectFilter) {
                    subjectFilter.addEventListener('change', loadStudentQuizzes);
                }
                
                if (clearHistoryBtn) {
                    clearHistoryBtn.addEventListener('click', clearStudentQuizHistory);
                }
            }

            // Clear current student's quiz history
            function clearStudentQuizHistory() {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    alert('No current user found.');
                    return;
                }
                
                if (!confirm('Are you sure you want to clear your quiz history?')) {
                    return;
                }
                
                const allResults = JSON.parse(localStorage.getItem('quizResults')) || [];
                const remaining = allResults.filter(r => r.userId !== currentUser.id);
                localStorage.setItem('quizResults', JSON.stringify(remaining));
                
                if (typeof showToast === 'function') {
                    showToast('Your quiz history has been cleared.');
                }
                
                // Refresh results display
                displayStudentQuizResults();
            }
            
            function loadStudentQuizzes() {
                (async () => {
                    console.log('Loading available quizzes for student');
                    const filterBranch = document.getElementById('student-quiz-branch')?.value || '';
                    const filterSemester = document.getElementById('student-quiz-semester')?.value || '';
                    const filterSubject = document.getElementById('student-quiz-subject')?.value || '';
                    const currentUser = getCurrentUser();
                    const resultsContainer = document.getElementById('student-available-quizzes');
                    if (!resultsContainer) return;

                    let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                    try {
                        const { apiRequest } = await import('./assets/js/api.js');
                        const res = await apiRequest('/quizzes', { method: 'GET' });
                        if (res && Array.isArray(res.quizzes)) {
                            quizzes = res.quizzes.map(q => ({
                                id: q._id,
                                name: q.name,
                                duration: q.duration,
                                branch: q.branch,
                                semester: q.semester,
                                subject: q.subject,
                                numQuestions: q.numQuestions,
                                setPaper: q.setPaper,
                                questions: q.questions,
                                createdAt: q.createdAt
                            }));
                            localStorage.setItem('quizzes', JSON.stringify(quizzes));
                        }
                    } catch (_) {}

                    quizzes = quizzes.filter(quiz => {
                        const matchesBranch = !filterBranch || quiz.branch === filterBranch;
                        const matchesSemester = !filterSemester || quiz.semester === filterSemester;
                        const matchesSubject = !filterSubject || quiz.subject === filterSubject;
                        return matchesBranch && matchesSemester && matchesSubject;
                    });

                    if (quizzes.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="text-center py-6">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-10 w-10 text-slate-400"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <h3 class="mt-2 text-base font-semibold text-slate-800">No quizzes available</h3>
                                <p class="mt-1 text-sm text-slate-500">No quizzes found matching your criteria. Try adjusting filters or check back later.</p>
                            </div>
                        `;
                    } else {
                        resultsContainer.innerHTML = quizzes.map(quiz => `
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-slate-800 text-lg">${quiz.name}</h4>
                                        <div class="flex flex-wrap items-center gap-2 mt-2">
                                            <span class="text-xs font-medium text-slate-600 bg-white px-2 py-1 rounded border">${quiz.subject}</span>
                                            <span class="text-xs font-medium text-slate-600 bg-white px-2 py-1 rounded border">${quiz.semester}</span>
                                            <span class="text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded border">${quiz.branch}</span>
                                            <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded border">${quiz.numQuestions} questions</span>
                                            <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded border">${quiz.duration} min</span>
                                            ${quiz.setPaper ? `<span class="text-xs font-medium text-orange-700 bg-orange-100 px-2 py-1 rounded border">${quiz.setPaper}</span>` : ''}
                                        </div>
                                        <p class="text-xs text-slate-500 mt-2">Created: ${new Date(quiz.createdAt).toLocaleDateString()}</p>
                                    </div>
                                    <div class="flex space-x-2 ml-4">
                                        <button class="start-quiz-btn bg-green-600 text-white font-semibold px-4 py-2 text-sm rounded-lg hover:bg-green-700 transition-colors" data-quiz-id="${quiz.id}">
                                            Start Quiz
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        setTimeout(() => {
                            const startButtons = resultsContainer.querySelectorAll('.start-quiz-btn');
                            startButtons.forEach(button => {
                                const newButton = button.cloneNode(true);
                                button.parentNode.replaceChild(newButton, button);
                                newButton.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    const quizId = this.getAttribute('data-quiz-id');
                                    startQuiz(quizId);
                                });
                            });
                        }, 100);
                    }

                    displayStudentQuizResults();
                })();
            }
            
            // Display student quiz results
            function displayStudentQuizResults() {
                const currentUser = getCurrentUser();
                if (!currentUser) return;
                
                const results = getQuizResults(currentUser.id);
                const resultsContainer = document.getElementById('student-quiz-results');
                if (!resultsContainer) return;
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center text-slate-500 py-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-slate-400"><path d="M12 2l-8 10h16l-8-10z"></path><path d="M12 12v8"></path></svg>
                            <p class="mt-2">No quiz results yet. Take a quiz to see your performance history!</p>
                        </div>
                    `;
                } else {
                    // Sort results by completion date (newest first)
                    const sortedResults = results.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));

                    // Lookup quiz names by ID for display
                    const quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                    const quizNameById = quizzes.reduce((acc, q) => {
                        acc[q.id] = q.name || `Quiz ${q.id}`;
                        return acc;
                    }, {});
                    
                    resultsContainer.innerHTML = sortedResults.map(result => {
                        const completedDate = new Date(result.completedAt);
                        const dateStr = completedDate.toLocaleDateString();
                        const timeStr = completedDate.toLocaleTimeString();
                        const quizName = quizNameById[result.quizId] || `Quiz ${result.quizId}`;
                        
                        return `
                            <div class="bg-white p-4 rounded-lg border border-slate-200">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-slate-800">${quizName}</h4>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-sm font-medium ${result.percentage >= 70 ? 'text-green-700 bg-green-100' : result.percentage >= 50 ? 'text-yellow-700 bg-yellow-100' : 'text-red-700 bg-red-100'} px-2 py-1 rounded">
                                                ${result.percentage}%
                                            </span>
                                            <span class="text-sm text-slate-600">
                                                ${result.marks}/${result.totalMarks} marks
                                            </span>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-1">
                                            Completed: ${dateStr} at ${timeStr}
                                        </p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button class="view-result-details-btn bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded hover:bg-blue-700 transition-colors" data-result-id="${result.id}">
                                            View Details
                                        </button>
                                        <button class="view-solution-btn bg-purple-600 text-white text-xs font-semibold px-3 py-1 rounded hover:bg-purple-700 transition-colors" data-result-id="${result.id}">
                                            View Solution
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Add event listeners for view details buttons
                    setTimeout(() => {
                        const detailButtons = resultsContainer.querySelectorAll('.view-result-details-btn');
                        detailButtons.forEach(button => {
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                            newButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                const resultId = this.getAttribute('data-result-id');
                                showQuizResultDetails(resultId);
                            });
                        });
                        const solutionButtons = resultsContainer.querySelectorAll('.view-solution-btn');
                        solutionButtons.forEach(button => {
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                            newButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                const resultId = this.getAttribute('data-result-id');
                                // Show in-app modal with solution steps
                                showQuizSolution(resultId);
                            });
                        });
                    }, 100);
                }
            }
            
            // Show detailed quiz result
            function showQuizResultDetails(resultId) {
                const currentUser = getCurrentUser();
                if (!currentUser) return;
                
                const results = getQuizResults(currentUser.id);
                const result = results.find(r => r.id == resultId);
                
                if (!result) {
                    alert('Result not found!');
                    return;
                }
                
                // Lookup quiz for option texts (fallback to saved option texts if unavailable)
                const quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                const quiz = quizzes.find(q => q.id === result.quizId);
                
                function getUserOptionText(answer) {
                    if (answer.userOptionText) return answer.userOptionText;
                    const idx = answer.userAnswer != null ? parseInt(answer.userAnswer, 10) : null;
                    const opts = quiz && quiz.questions && quiz.questions[answer.questionIndex] && quiz.questions[answer.questionIndex].options;
                    if (idx === null) return 'Not answered';
                    return (opts && opts[idx] !== undefined) ? String(opts[idx]) : String(answer.userAnswer);
                }
                function getCorrectOptionText(answer) {
                    if (answer.correctOptionText) return answer.correctOptionText;
                    const idx = answer.correctAnswer != null ? parseInt(answer.correctAnswer, 10) : null;
                    const opts = quiz && quiz.questions && quiz.questions[answer.questionIndex] && quiz.questions[answer.questionIndex].options;
                    return (idx != null && opts && opts[idx] !== undefined) ? String(opts[idx]) : String(answer.correctAnswer ?? '—');
                }
                
                // Create a detailed view of the result
                const detailsHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-slate-800">Quiz Result Details</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-slate-500 hover:text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                            <div class="mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-lg font-bold ${result.percentage >= 70 ? 'text-green-700' : result.percentage >= 50 ? 'text-yellow-700' : 'text-red-700'}">
                                        Score: ${result.percentage}%
                                    </span>
                                    <span class="text-slate-600">(${result.marks}/${result.totalMarks} marks; ${result.score}/${result.totalQuestions} correct)</span>
                                </div>
                                <p class="text-sm text-slate-500">
                                    Completed: ${new Date(result.completedAt).toLocaleString()}
                                </p>
                            </div>
                            <div class="space-y-3">
                                <h4 class="font-semibold text-slate-800">Question Breakdown:</h4>
                                ${result.answers.map((answer, index) => `
                                    <div class="border border-slate-200 rounded p-3 ${answer.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-sm font-medium">Q${index + 1}:</span>
                                            <span class="text-xs px-2 py-1 rounded ${answer.isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                                ${answer.isCorrect ? 'Correct' : 'Incorrect'}
                                            </span>
                                        </div>
                                        <p class="text-sm text-slate-700 mb-1">${answer.question}</p>
                                        <div class="text-xs text-slate-600">
                                            <div>Your answer: ${getUserOptionText(answer)}</div>
                                            <div>Correct answer: ${getCorrectOptionText(answer)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add the modal to the page
                document.body.insertAdjacentHTML('beforeend', detailsHtml);
            }

            // Show correct answers (solutions) for a quiz result
            function showQuizSolution(resultId) {
                const currentUser = getCurrentUser();
                if (!currentUser) return;

                const results = getQuizResults(currentUser.id);
                const result = results.find(r => r.id == resultId);
                if (!result) {
                    alert('Result not found!');
                    return;
                }

                // Fetch quiz to map option indexes to actual option text
                const quizzes = JSON.parse(localStorage.getItem('quizzes')) || [];
                const quiz = quizzes.find(q => q.id === result.quizId);

                const detailsHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-slate-800">Quiz Solutions</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-slate-500 hover:text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                ${result.answers.map((answer, index) => {
                                    // Derive readable texts for correct and user answers
                                    let correctText = answer.correctAnswer;
                                    let userText = (typeof answer.userAnswer !== 'undefined' && answer.userAnswer !== null) ? answer.userAnswer : null;

                                    if (quiz && quiz.questions && quiz.questions[answer.questionIndex]) {
                                        const q = quiz.questions[answer.questionIndex];
                                        const correctIdx = parseInt(answer.correctAnswer, 10);
                                        const userIdx = userText !== null ? parseInt(answer.userAnswer, 10) : null;

                                        if (Array.isArray(q.options)) {
                                            if (!Number.isNaN(correctIdx) && q.options[correctIdx] !== undefined) {
                                                const letter = String.fromCharCode(65 + correctIdx);
                                                correctText = `${letter}. ${q.options[correctIdx]}`;
                                            }
                                            if (userIdx !== null && !Number.isNaN(userIdx) && q.options[userIdx] !== undefined) {
                                                const letterU = String.fromCharCode(65 + userIdx);
                                                userText = `${letterU}. ${q.options[userIdx]}`;
                                            } else if (userText === null) {
                                                userText = 'Not answered';
                                            }
                                        }
                                    } else {
                                        // Fallback if quiz data missing: keep index values, make them readable
                                        const cIdx = parseInt(answer.correctAnswer, 10);
                                        if (!Number.isNaN(cIdx)) {
                                            correctText = `Option ${String.fromCharCode(65 + cIdx)} (index ${cIdx})`;
                                        }
                                        if (userText !== null) {
                                            const uIdx = parseInt(answer.userAnswer, 10);
                                            if (!Number.isNaN(uIdx)) {
                                                userText = `Option ${String.fromCharCode(65 + uIdx)} (index ${uIdx})`;
                                            }
                                        } else {
                                            userText = 'Not answered';
                                        }
                                    }

                                    // Compose optional stepwise solution if available
                                    const qSteps = (quiz && quiz.questions && quiz.questions[answer.questionIndex] && Array.isArray(quiz.questions[answer.questionIndex].solutionSteps))
                                        ? quiz.questions[answer.questionIndex].solutionSteps
                                        : (Array.isArray(answer.solutionSteps) ? answer.solutionSteps : null);
                                    const stepsHtml = (Array.isArray(qSteps) && qSteps.length > 0)
                                        ? `
                                            <div class="mt-2">
                                                <div class="text-xs font-semibold text-slate-700 mb-1">Solution Steps</div>
                                                <ol class="list-decimal ml-6 text-xs text-slate-700 space-y-1">
                                                    ${qSteps.map(s => `<li>${s}</li>`).join('')}
                                                </ol>
                                            </div>
                                          `
                                        : '';

                                    return `
                                        <div class="border border-slate-200 rounded p-3 bg-slate-50">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-sm font-medium">Q${index + 1}:</span>
                                                <span class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">Correct Answer</span>
                                            </div>
                                            <p class="text-sm text-slate-700 mb-1">${answer.question}</p>
                                            <div class="text-xs text-slate-700">
                                                <div>Correct: ${correctText}</div>
                                                ${typeof answer.userAnswer !== 'undefined' ? `<div>Your answer: ${userText}</div>` : ''}
                                            </div>
                                            ${stepsHtml}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', detailsHtml);
            }
            
            // loadStudentQuizzes function removed - no longer needed since View Available Quizzes section was removed
            
            // Update the hashchange listener to handle student quizzes
            window.addEventListener('hashchange', function() {
                console.log('Hash changed to:', window.location.hash);
                handleNavigation();
            });
            
            // Initialize on first load
            handleNavigation();
            
            // Also initialize on page load if already on student quizzes page
            if (window.location.hash === '#student-quizzes') {
                console.log('Initializing student quizzes on page load');
                updateDashboardQuizCount();
                setTimeout(initStudentQuizzes, 100);
            } else if (window.location.hash === '#quizzes') {
                console.log('Initializing quiz management on page load');
                setTimeout(initQuizManagement, 100);
            }
        });
    </script>
    <script type="module" src="assets/js/api.js"></script>
    
    <!-- Floating AI Assistant Widget -->
    <div id="assistant-widget" class="fixed bottom-6 right-6 z-50">
        <!-- Toggle Button -->
        <button id="assistant-toggle" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            Ask AI
        </button>
        
        <!-- Panel -->
        <div id="assistant-panel" class="hidden mt-3 w-[360px] max-w-[90vw] bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3 text-white">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2Z"></path></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-sm">AI Assistant</p>
                        <p class="text-blue-100 text-xs">Ask anything, I’m here to help</p>
                    </div>
                </div>
                <button id="assistant-close" class="text-white/90 hover:text-white" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>
            
            <!-- Suggested Prompts -->
            <div class="px-3 pt-3 bg-white">
                <p class="text-xs text-slate-600 mb-2">Suggestions</p>
                <div class="grid grid-cols-1 gap-2">
                    <button class="assistant-suggest bg-white hover:bg-blue-50 border border-slate-200 hover:border-blue-300 rounded-lg p-2 text-left transition-all text-sm">
                        Explain object-oriented programming principles
                    </button>
                    <button class="assistant-suggest bg-white hover:bg-blue-50 border border-slate-200 hover:border-blue-300 rounded-lg p-2 text-left transition-all text-sm">
                        What are the ACID properties in databases?
                    </button>
                    <button class="assistant-suggest bg-white hover:bg-blue-50 border border-slate-200 hover:border-blue-300 rounded-lg p-2 text-left transition-all text-sm">
                        What is the difference between stack and queue?
                    </button>
                </div>
            </div>
            
            <!-- Messages -->
            <div id="assistant-chat" class="max-h-[320px] overflow-y-auto p-3 space-y-3 bg-slate-50"></div>
            
            <!-- Input -->
            <form id="assistant-form" class="border-t border-slate-200 p-3 flex items-center gap-2">
                <input id="assistant-input" type="text" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Type your question..." />
                <button id="assistant-send" type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">Send</button>
            </form>
        </div>
    </div>
    
    <!-- Chat Widget Script -->
    <script type="module" src="assets/js/chatWidget.js"></script>
</body>
</html>