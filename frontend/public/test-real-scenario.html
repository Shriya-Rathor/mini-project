<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real Quiz Scenario</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .quiz-item { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Test Real Quiz Scenario</h1>
    
    <div class="section">
        <h2>Step 1: Setup Test Environment</h2>
        <button onclick="setupTeacherUser()">Login as Teacher</button>
        <button onclick="setupStudentUser()">Login as Student</button>
        <button onclick="checkCurrentUser()">Check Current User</button>
        <div id="user-status"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: Create Quiz as Teacher</h2>
        <button onclick="createQuizAsTeacher()">Create Test Quiz</button>
        <div id="quiz-creation-status"></div>
    </div>
    
    <div class="section">
        <h2>Step 3: Switch to Student View</h2>
        <button onclick="switchToStudent()">Switch to Student View</button>
        <div id="switch-status"></div>
    </div>
    
    <div class="section">
        <h2>Step 4: Check Available Quizzes</h2>
        <button onclick="checkAvailableQuizzes()">Check Available Quizzes</button>
        <div id="available-quizzes"></div>
    </div>
    
    <div class="section">
        <h2>Step 5: Debug Analysis</h2>
        <button onclick="runDebugAnalysis()">Run Debug Analysis</button>
        <div id="debug-analysis"></div>
    </div>
    
    <div class="section">
        <h2>Step 6: Clear All Data</h2>
        <button onclick="clearAllData()">Clear All Data</button>
    </div>

    <script>
        // Mock functions from the main application
        function getCurrentUser() {
            try {
                const userData = localStorage.getItem('currentUser');
                return userData ? JSON.parse(userData) : null;
            } catch (e) {
                console.error('Error parsing current user:', e);
                return null;
            }
        }
        
        function setCurrentUser(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }
        
        function getQuizzes() {
            try {
                const quizzesData = localStorage.getItem('quizzes');
                return quizzesData ? JSON.parse(quizzesData) : [];
            } catch (e) {
                console.error('Error parsing quizzes:', e);
                return [];
            }
        }
        
        function saveQuizzes(quizzes) {
            localStorage.setItem('quizzes', JSON.stringify(quizzes));
        }
        
        // Test functions
        function setupTeacherUser() {
            const teacher = {
                id: 'teacher_test_001',
                name: 'Test Teacher',
                email: 'teacher@test.com',
                role: 'teacher',
                branch: 'COMPS',
                semester: 'Semester 3'
            };
            
            setCurrentUser(teacher);
            document.getElementById('user-status').innerHTML = `
                <p class="success">Teacher user set up successfully!</p>
                <pre>${JSON.stringify(teacher, null, 2)}</pre>
            `;
        }
        
        function setupStudentUser() {
            const student = {
                id: 'student_test_001',
                name: 'Test Student',
                email: 'student@test.com',
                role: 'student',
                branch: 'COMPS',
                semester: 'Semester 3'
            };
            
            setCurrentUser(student);
            document.getElementById('user-status').innerHTML = `
                <p class="success">Student user set up successfully!</p>
                <pre>${JSON.stringify(student, null, 2)}</pre>
            `;
        }
        
        function checkCurrentUser() {
            const user = getCurrentUser();
            const userStatus = document.getElementById('user-status');
            
            if (!user) {
                userStatus.innerHTML = '<p class="error">No current user found!</p>';
                return;
            }
            
            userStatus.innerHTML = `
                <p class="info">Current user:</p>
                <pre>${JSON.stringify(user, null, 2)}</pre>
            `;
        }
        
        function createQuizAsTeacher() {
            const user = getCurrentUser();
            const statusDiv = document.getElementById('quiz-creation-status');
            
            if (!user) {
                statusDiv.innerHTML = '<p class="error">No user logged in!</p>';
                return;
            }
            
            if (user.role !== 'teacher') {
                statusDiv.innerHTML = '<p class="warning">Current user is not a teacher!</p>';
            }
            
            // Create quiz using the exact same logic as the main application
            const quiz = {
                id: 'quiz_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: 'Teacher Created Test Quiz',
                duration: 30,
                branch: user.branch || 'COMPS',
                semester: user.semester || 'Semester 3',
                subject: 'CSE',
                numQuestions: 5,
                setPaper: '',
                createdAt: new Date().toISOString(),
                createdBy: user.id,
                questions: [
                    { question: "What is a data structure?", options: ["A way to store data", "A programming language", "A type of computer", "An algorithm"], correctAnswer: 0 },
                    { question: "What is the time complexity of binary search?", options: ["O(n)", "O(log n)", "O(nÂ²)", "O(1)"], correctAnswer: 1 }
                ]
            };
            
            const quizzes = getQuizzes();
            quizzes.push(quiz);
            saveQuizzes(quizzes);
            
            statusDiv.innerHTML = `
                <p class="success">Quiz created successfully!</p>
                <div class="quiz-item">
                    <strong>${quiz.name}</strong><br>
                    ID: ${quiz.id}<br>
                    Branch: ${quiz.branch} | Semester: ${quiz.semester}<br>
                    Subject: ${quiz.subject}<br>
                    Created by: ${quiz.createdBy} (${user.role})<br>
                    Created at: ${new Date(quiz.createdAt).toLocaleString()}
                </div>
            `;
        }
        
        function switchToStudent() {
            const student = {
                id: 'student_test_001',
                name: 'Test Student',
                email: 'student@test.com',
                role: 'student',
                branch: 'COMPS',
                semester: 'Semester 3'
            };
            
            setCurrentUser(student);
            document.getElementById('switch-status').innerHTML = `
                <p class="success">Switched to student view!</p>
                <pre>${JSON.stringify(student, null, 2)}</pre>
            `;
        }
        
        function checkAvailableQuizzes() {
            const user = getCurrentUser();
            const availableDiv = document.getElementById('available-quizzes');
            
            if (!user) {
                availableDiv.innerHTML = '<p class="error">No user logged in!</p>';
                return;
            }
            
            const allQuizzes = getQuizzes();
            
            // Apply the exact same filtering logic as loadStudentQuizzes
            const filteredQuizzes = allQuizzes.filter(quiz => {
                const matchesStudentBranch = !user.branch || quiz.branch === user.branch;
                const matchesStudentSemester = !user.semester || quiz.semester === user.semester;
                
                return matchesStudentBranch && matchesStudentSemester;
            });
            
            availableDiv.innerHTML = `
                <p class="info">Available quizzes for student:</p>
                <p>Total quizzes in system: ${allQuizzes.length}</p>
                <p>Quizzes visible to student: ${filteredQuizzes.length}</p>
                <p>Student branch: ${user.branch} | Student semester: ${user.semester}</p>
                
                ${filteredQuizzes.length > 0 ? `
                    <p class="success">Visible quizzes:</p>
                    ${filteredQuizzes.map(quiz => `
                        <div class="quiz-item" style="background: #e8f5e8;">
                            <strong>${quiz.name}</strong><br>
                            ID: ${quiz.id}<br>
                            Branch: ${quiz.branch} | Semester: ${quiz.semester}<br>
                            Subject: ${quiz.subject}<br>
                            Created by: ${quiz.createdBy}<br>
                            Created at: ${new Date(quiz.createdAt).toLocaleString()}
                        </div>
                    `).join('')}
                ` : '<p class="error">No quizzes visible to student!</p>'}
                
                ${allQuizzes.length > filteredQuizzes.length ? `
                    <p class="warning">Hidden quizzes (wrong branch/semester):</p>
                    ${allQuizzes.filter(quiz => !filteredQuizzes.includes(quiz)).map(quiz => `
                        <div class="quiz-item" style="background: #ffeaea;">
                            <strong>${quiz.name}</strong><br>
                            Branch: ${quiz.branch} | Semester: ${quiz.semester}<br>
                            Created by: ${quiz.createdBy}
                        </div>
                    `).join('')}
                ` : ''}
            `;
        }
        
        function runDebugAnalysis() {
            const user = getCurrentUser();
            const allQuizzes = getQuizzes();
            const analysisDiv = document.getElementById('debug-analysis');
            
            if (!user) {
                analysisDiv.innerHTML = '<p class="error">No user logged in!</p>';
                return;
            }
            
            const teacherQuizzes = allQuizzes.filter(quiz => quiz.createdBy && quiz.createdBy.includes('teacher'));
            const studentQuizzes = allQuizzes.filter(quiz => quiz.createdBy && quiz.createdBy.includes('student'));
            const matchingQuizzes = allQuizzes.filter(quiz => {
                const matchesStudentBranch = !user.branch || quiz.branch === user.branch;
                const matchesStudentSemester = !user.semester || quiz.semester === user.semester;
                return matchesStudentBranch && matchesStudentSemester;
            });
            
            analysisDiv.innerHTML = `
                <h3>Debug Analysis:</h3>
                <p>Current user: ${user.name} (${user.role})</p>
                <p>User branch: ${user.branch} | User semester: ${user.semester}</p>
                <p>Total quizzes: ${allQuizzes.length}</p>
                <p>Teacher-created quizzes: ${teacherQuizzes.length}</p>
                <p>Student-created quizzes: ${studentQuizzes.length}</p>
                <p>Quizzes matching student criteria: ${matchingQuizzes.length}</p>
                
                <h4>Teacher quizzes matching student criteria:</h4>
                ${teacherQuizzes.filter(quiz => {
                    const matchesStudentBranch = !user.branch || quiz.branch === user.branch;
                    const matchesStudentSemester = !user.semester || quiz.semester === user.semester;
                    return matchesStudentBranch && matchesStudentSemester;
                }).map(quiz => `
                    <div class="quiz-item" style="background: #e8f5e8;">
                        <strong>${quiz.name}</strong> (Should be visible!)<br>
                        Branch: ${quiz.branch} | Semester: ${quiz.semester}
                    </div>
                `).join('') || '<p class="error">No teacher quizzes match student criteria!</p>'}
                
                <h4>All quizzes breakdown:</h4>
                ${allQuizzes.map(quiz => `
                    <div class="quiz-item">
                        <strong>${quiz.name}</strong><br>
                        Branch: ${quiz.branch} | Semester: ${quiz.semester}<br>
                        Created by: ${quiz.createdBy}<br>
                        Should be visible: ${(!user.branch || quiz.branch === user.branch) && (!user.semester || quiz.semester === user.semester) ? '<span class="success">YES</span>' : '<span class="error">NO</span>'}
                    </div>
                `).join('')}
            `;
        }
        
        function clearAllData() {
            localStorage.removeItem('quizzes');
            localStorage.removeItem('currentUser');
            alert('All data cleared!');
            location.reload();
        }
        
        // Auto-run setup on page load
        window.onload = function() {
            console.log('Test page loaded');
            
            // Check if we have users, if not create them
            const user = getCurrentUser();
            if (!user) {
                setupTeacherUser();
            }
        };
    </script>
</body>
</html>